<!DOCTYPE html>

<html lang="zh-CN">
<head>
    <meta charset="utf-8"/>
    <link href="{{ url_for('static', filename='bid.png') }}" rel="icon" type="image/png"/>
    <title>æŠ•æ ‡å®¢æˆ·ç™»è®° - äº‘å—å›½åˆ</title>
    <meta content="width=device-width, initial-scale=1" name="viewport"/>
    <!-- Bootstrap 5 CDN -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet"/>
    <style>
        html, body {
            font-family: "Microsoft YaHei", sans-serif;
            background-size: cover;
            min-width: 1200px; /* é”å®šæœ€å°å®½åº¦é¿å…æŒ‰é’®é®ä½å¡ç‰‡ */
            overflow-x: auto;
        }

        .overlay {
            background-color: rgba(255, 255, 255, 0.97);
            padding: 40px 50px;
            border-radius: 12px;
            width: 100%;
            max-width: 900px;
            min-height: 600px;
            box-shadow: 0 0 16px rgba(0, 0, 0, 0.2);
            margin: 100px auto 40px auto;
            box-sizing: border-box;
            position: relative;
            z-index: 10; /* å§‹ç»ˆé«˜äºæŒ‰é’® */
        }

        /* ç®¡ç†å‘˜ç™»å½•æŒ‰é’® */
        .admin-login-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        /* è‡ªåŠ¨è¡¥å…¨å»ºè®®æ¡† */
        .autocomplete-suggestions {
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            background-color: #fff;
            position: absolute;
            width: 100%;
            z-index: 1000;
        }

        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }

        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }

        /* é—ªçƒåŠ¨ç”» */
        @keyframes flash {
            0%, 50%, 100% {
                opacity: 1;
            }
            25%, 75% {
                opacity: 0.3;
            }
        }

        .flash-animate {
            animation: flash 1s ease-in-out;
        }

        /* âœ… å·¦å³ä¸‹è§’åœ†æŒ‰é’®æ ·å¼ */
        .faq-btn, .bot-btn {
            width: 90px;
            height: 90px;
            position: fixed;
            bottom: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            border: none;
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
            z-index: 999;
        }

        .faq-btn {
            left: 40px;
            background-color: #007bff;
            color: white;
        }

        .bot-btn {
            right: 40px;
            background-color: #28a745;
            color: white;
            font-size: 30px;
        }

        .faq-btn span, .bot-btn span {
            font-size: 12px;
            margin-top: 4px;
            color: white;
        }

        .faq-icon, .bot-icon {
            width: 24px;
            height: 24px;
            fill: white;
        }

        /* FAQ å¼¹å‡ºæ°”æ³¡ */
        .faq-bubble {
            position: fixed;
            bottom: 160px;
            left: 30px;
            background: #fff;
            border-radius: 10px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            padding: 15px;
            width: 280px;
            display: none;
            z-index: 1000;
        }

        .faq-item {
            margin-bottom: 10px;
        }

        .faq-question {
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            cursor: pointer;
        }

        .faq-answer {
            display: none;
            font-size: 0.9em;
            color: #555;
            margin-top: 5px;
        }

        /* èŠå¤©çª—å£ */
        .chat-window {
            position: fixed;
            bottom: 180px;
            right: 30px;
            width: 350px;
            max-height: 500px;
            background-color: #fff;
            border-radius: 12px;
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.3);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
        }

        .chat-header {
            background-color: #28a745;
            color: white;
            padding: 12px;
            font-weight: bold;
        }

        .chat-body {
            flex: 1;
            padding: 10px;
            overflow-y: auto;
        }

        .chat-message {
            margin-bottom: 10px;
        }

        .chat-message.user {
            text-align: right;
        }

        .chat-message.bot {
            text-align: left;
        }

        .chat-footer {
            border-top: 1px solid #ddd;
            padding: 10px;
        }

        .chat-footer input {
            width: 100%;
            padding: 6px 10px;
            border-radius: 6px;
            border: 1px solid #ccc;
        }

        /* èŠå¤©æ¶ˆæ¯æ ·å¼ */
        .msg-row {
            display: flex;
            align-items: flex-end;
            margin-bottom: 10px;
        }

        .msg-row.user {
            justify-content: flex-end;
        }

        .msg-row.bot {
            justify-content: flex-start;
        }

        .avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: #ccc;
            margin: 0 8px;
            text-align: center;
            line-height: 32px;
            font-size: 14px;
            font-weight: bold;
        }

        .bubble {
            padding: 8px 12px;
            border-radius: 16px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .user .bubble {
            background-color: #d1f0d1;
            color: #000;
            border-bottom-right-radius: 2px;
        }

        .bot .bubble {
            background-color: #eee;
            color: #000;
            border-bottom-left-radius: 2px;
        }

        .chat-reset {
            background: transparent;
            color: white;
            border: none;
            font-size: 14px;
            cursor: pointer;
        }

        /* âœ… å“åº”å¼ï¼šå°å±å¹•ä¸‹ä¸¤ä¸ªæŒ‰é’®èšåˆåˆ°åº•éƒ¨ä¸­é—´ */
        @media (max-width: 768px) {
            .faq-btn {
                left: 50%;
                transform: translateX(-110%);
                bottom: 20px;
            }

            .bot-btn {
                right: 50%;
                transform: translateX(110%);
                bottom: 20px;
            }
        }
    </style>
    <style>
        .alert-info {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
<!-- ç®¡ç†å‘˜ç™»å½•æŒ‰é’® -->
<div class="admin-login-btn">
    <a class="btn btn-outline-primary" href="{{ url_for('login') }}">ç®¡ç†å‘˜ç™»å½•</a>
</div>
<div class="overlay">
    <h2 class="mb-4">ğŸ“‹ æŠ•æ ‡ä¿¡æ¯ç™»è®°è¡¨</h2>

    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="flash-container">
        {% for category, message in messages %}
        <div class="alert alert-{{ category }} flash-animate">{{ message }}</div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}


    <div class="alert alert-info">ä»…ç°åœºæŠ¥åæœ‰æ•ˆ; å¡«æŠ¥æ—¶è¯·ä»”ç»†æ£€æŸ¥ä¿¡æ¯ï¼Œå¦åˆ™åæœè‡ªè´Ÿ</div>

    {% if not business_open %}
    <div class="alert alert-danger">âš ï¸ å½“å‰ä¸ºéæŠ•æ ‡æ—¶é—´ï¼ˆä»…å·¥ä½œæ—¥ 9:00 ~ 17:00ï¼‰ï¼Œè¯·å‹¿åœ¨éå·¥ä½œæ—¥æŠ•æ ‡ï¼Œå¦åˆ™ä¸äºˆå¤„ç†</div>
    {% endif %}
        <form id="registrationForm" action="/" class="row g-3" method="POST" onsubmit="console.log('ğŸŸ¢ è¡¨å•å‡†å¤‡æäº¤');">

        <input id="project_id" name="project_id" type="hidden"/>

        <div class="col-md-6 position-relative">
            <label class="form-label" for="project_code">
                é¡¹ç›®åç§°æˆ–ç¼–å·ï¼ˆæ”¯æŒæ¨¡ç³Šæœç´¢ï¼‰æœªæ‰¾åˆ°è¯´æ˜é¡¹ç›®æœªå¼€å§‹æˆ–å·²é€¾æœŸ
            </label>
            <input type="text" class="form-control" id="project_code" name="project_code"
                   placeholder="è‡³å°‘è¾“å…¥2å­—ç¬¦ï¼Œåç§°ç¼–å·å‡å¯"
                   value="{{ prefill.project_code if prefill else '' }}"
                   autocomplete="off"
                   required
                   {% if not business_open %}disabled{% endif %}>
            <div class="autocomplete-suggestions" id="autocomplete-suggestions"></div>
        </div>

        <div class="col-md-6" id="segment-wrapper" style="display: none;">
            <label class="form-label" for="sub_project_id">è¯·é€‰æ‹©æ ‡æ®µ</label>
            <select class="form-select" id="sub_project_id" name="sub_project_id">
                <option value="" selected>-- è¯·é€‰æ‹©æ ‡æ®µ --</option>
            </select>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="supplier_name">æŠ•æ ‡å•ä½åç§°</label>
            <input type="text" class="form-control" name="supplier_name"
                   value="{{ prefill.supplier_name if prefill else '' }}" required
                   {% if not business_open %}disabled{% endif %}>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="supplier_address">æŠ•æ ‡å•ä½åœ°å€</label>
            <input type="text" class="form-control" name="supplier_address"
                   value="{{ prefill.supplier_address if prefill else '' }}" required
                   {% if not business_open %}disabled{% endif %}>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="legal_person">æ³•å®šä»£è¡¨äºº</label>
            <input type="text" class="form-control" name="legal_person"
                   value="{{ prefill.legal_person if prefill else '' }}" required
                   {% if not business_open %}disabled{% endif %}>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="credit_code">ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç </label>
            <input type="text" class="form-control" id="credit_code" name="credit_code" maxlength="18"
                   placeholder="ç³»ç»Ÿå¯è‡ªåŠ¨è½¬å¤§å†™å­—æ¯"
                   value="{{ prefill.credit_code if prefill else '' }}" required
                   {% if not business_open %}disabled{% endif %}>
            <!-- é”™è¯¯æç¤º -->
            <div class="error-message" id="credit_code_illegal_letter_error"
                 style="color: red; font-size: 14px; margin-top: 5px; display: none;">
                âŒ ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç ä¸­ä¸èƒ½åŒ…å« Iã€Oã€Zã€Sã€Vï¼
            </div>
            <div class="error-message" id="credit_code_special_char_error"
                 style="color: red; font-size: 14px; margin-top: 5px; display: none;">
                âŒ ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç åªèƒ½è¾“å…¥æ•°å­—å’Œå¤§å†™è‹±æ–‡å­—æ¯ï¼Œä¸èƒ½åŒ…å«ç‰¹æ®Šå­—ç¬¦ï¼
            </div>
            <div class="error-message" id="credit_code_length_error"
                 style="color: blueviolet; font-size: 14px; margin-top: 5px; display: none;">
                ç»Ÿä¸€ç¤¾ä¼šä¿¡ç”¨ä»£ç å¿…é¡»æ˜¯18ä½ï¼
            </div>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="agent">å§”æ‰˜ä»£ç†äºº</label>
            <input type="text" class="form-control" name="agent"
                   value="{{ prefill.agent if prefill else '' }}"
                   {% if not business_open %}disabled{% endif %}>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="phone">æ‰‹æœºå·ç </label>
            <input type="text" class="form-control" name="phone" required
                   placeholder="è¯·è¾“å…¥11ä½æœ‰æ•ˆæ‰‹æœºå·ç "
                   value="{{ prefill.phone if prefill else '' }}"
                   {% if not business_open %}disabled{% endif %}>
            <div class="error hidden" id="phone-error"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label" for="email">ç”µå­é‚®ç®±</label>
            <input type="email" class="form-control" id="email" name="email" required
                   placeholder="è¯·è¾“å…¥æœ‰æ•ˆçš„é‚®ç®±ï¼ˆä»¥ .com ç»“å°¾ï¼‰"
                   value="{{ prefill.email if prefill else '' }}"
                   {% if not business_open %}disabled{% endif %}>
            <div class="error hidden" id="email-error"></div>
        </div>

        <div class="col-md-6">
            <label class="form-label">è·å–æ–‡ä»¶æ–¹å¼</label>
            <input type="text" class="form-control" name="file_method" value="ç°åœºè·å–" readonly>
        </div>

        <div class="col-md-6">
            <label class="form-label">å½“å‰æ—¶é—´ï¼ˆè‡ªåŠ¨è®°å½•ï¼‰</label>
            <input type="text" class="form-control" name="file_time" value="{{ now_string() }}" readonly>
        </div>

        <div class="col-12">
            <button id="submit_button" type="submit" class="btn btn-primary" {% if not business_open %}disabled{% endif %}>
                æäº¤ç™»è®°ä¿¡æ¯
            </button>

        </div>
    </form>

</div>
<!-- FAQå›¾æ ‡æŒ‰é’® -->
<!--<button class="faq-btn" onclick="toggleFAQ()">-->
<!--    <svg class="faq-icon" viewBox="0 0 24 24">-->
<!--        <path d="M12 2C6.5 2 2 6 2 12s4.5 10 10 10 10-4 10-10S17.5 2 12 2zm0 17.3c-.8 0-1.5-.7-1.5-1.5S11.2 16.3 12 16.3s1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm2-6.6l-.9.9c-.6.6-.9 1.1-.9 2h-2c0-1.3.5-2.1 1.3-2.8l1.2-1.2c.5-.5.8-1.1.8-1.8 0-1.3-1.1-2.3-2.4-2.3s-2.3 1-2.3 2.3H7c0-2.5 2-4.5 4.5-4.5S16 7.5 16 10c0 1-.4 2-1 2.7z"/>-->
<!--    </svg>-->
<!--</button>-->
<button class="faq-btn" onclick="toggleFAQ()">
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg class="faq-icon" viewbox="0 0 24 24">
            <path d="M12 2C6.5 2 2 6 2 12s4.5 10 10 10 10-4 10-10S17.5 2 12 2zm0 17.3c-.8 0-1.5-.7-1.5-1.5S11.2 16.3 12 16.3s1.5.7 1.5 1.5-.7 1.5-1.5 1.5zm2-6.6l-.9.9c-.6.6-.9 1.1-.9 2h-2c0-1.3.5-2.1 1.3-2.8l1.2-1.2c.5-.5.8-1.1.8-1.8 0-1.3-1.1-2.3-2.4-2.3s-2.3 1-2.3 2.3H7c0-2.5 2-4.5 4.5-4.5S16 7.5 16 10c0 1-.4 2-1 2.7z"></path>
        </svg>
        <span style="font-size: 20px; color: white; margin-top: 2px;">å¸¸è§é—®é¢˜</span>
    </div>
</button>
<!-- DeepSeekæœºå™¨äººæŒ‰é’® -->
<!--<button class="bot-btn" onclick="toggleChat()">-->
<!--    <svg class="bot-icon" viewBox="0 0 24 24">-->
<!--        <path d="M12 2a2 2 0 012 2v1h5a1 1 0 011 1v11a2 2 0 01-2 2h-3.1c-.5 1.2-1.6 2-2.9 2s-2.4-.8-2.9-2H6a2 2 0 01-2-2V6a1 1 0 011-1h5V4a2 2 0 012-2zm0 16a1 1 0 100-2 1 1 0 000 2zm-4-6a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z"/>-->
<!--    </svg>-->
<!--</button>-->
<button class="bot-btn" onclick="toggleChat()">
    <div style="display: flex; flex-direction: column; align-items: center;">
        <svg class="bot-icon" viewbox="0 0 24 24">
            <path d="M12 2a2 2 0 012 2v1h5a1 1 0 011 1v11a2 2 0 01-2 2h-3.1c-.5 1.2-1.6 2-2.9 2s-2.4-.8-2.9-2H6a2 2 0 01-2-2V6a1 1 0 011-1h5V4a2 2 0 012-2zm0 16a1 1 0 100-2 1 1 0 000 2zm-4-6a1 1 0 100-2 1 1 0 000 2zm8 0a1 1 0 100-2 1 1 0 000 2z"></path>
        </svg>
        <span style="font-size: 20px; color: white; margin-top: 2px;">AIåŠ©æ‰‹</span>
    </div>
</button>
<!-- æ°”æ³¡å†…å®¹ -->
<div class="faq-bubble" id="faqBubble">
    <h6>â“ å¸¸è§é—®é¢˜</h6>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ æ€ä¹ˆæ¥æ”¶æ ‡ä¹¦ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">æŠ¥åå¹¶ä»˜è´¹æˆåŠŸåç³»ç»Ÿå°†è‡ªåŠ¨å‘é€æ ‡ä¹¦è‡³æ‚¨çš„é¢„ç•™é‚®ç®±ã€‚</div>
    </div>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ æ ‡ä¹¦è´¹ç”¨æ€ä¹ˆæ”¯ä»˜ï¼Ÿ èƒ½å¼€å‘ç¥¨å—ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">å¾®ä¿¡ï¼Œç°é‡‘ï¼Œæ”¯ä»˜å®ï¼Œå¯¹å…¬è½¬è´¦éƒ½èƒ½æ”¯ä»˜ï¼Œå¦‚éœ€å¼€ç¥¨åªèƒ½å…¬å¯¹å…¬ã€‚</div>
    </div>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ æŠ¥åæˆªæ­¢æ—¶é—´ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">ä»¥æ‹›æ ‡å…¬å‘Šä¸ºå‡†ï¼Œç³»ç»Ÿè‡ªåŠ¨åŒæ­¥ã€‚</div>
    </div>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ è´­ä¹°æ ‡ä¹¦éœ€è¦æä¾›å“ªäº›èµ„æ–™ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">æ³•äººèº«ä»½è¯æ˜ä¹¦å’Œæˆæƒå§”æ‰˜ä¹¦ã€‚</div>
    </div>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ æŠ¥åè´¹æ˜¯å¤šå°‘ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">è´¹ç”¨è¯·çœ‹æ‹›æ ‡å…¬å‘Šã€‚</div>
    </div>
    <div class="faq-item">
        <div class="faq-question" onclick="toggleAnswer(this)">ğŸ“Œ æ ‡ä¹¦æ˜¯çº¸è´¨ç‰ˆå—ï¼Ÿ<span>+</span></div>
        <div class="faq-answer">æ ‡ä¹¦æ˜¯ç”µå­ç‰ˆ,æ‚¨éœ€è¦è‡ªå·±å¡«å†™å¹¶æ‰“å°ã€‚</div>
    </div>
</div>
<!-- èŠå¤©çª—å£ -->
<div class="chat-window" id="chatWindow">
    <div class="chat-header">
        <span>AI æŠ•æ ‡åŠ©æ‰‹</span>
        <button class="chat-reset" onclick="resetChat()">ğŸ—‘ æ¸…ç©º</button>
    </div>
    <div class="chat-body" id="chatBody">
        <div class="chat-message bot">äº²çˆ±çš„å®¢æˆ·æ‚¨å¥½ï¼Œæˆ‘æ˜¯äº‘å—å›½åˆå»ºè®¾æ‹›æ ‡å’¨è¯¢å…¬å¸çš„AIæœºå™¨äººåŠ©æ‰‹ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆç–‘é—®å‘¢ï¼Ÿ
        </div>
    </div>
    <!--    <div class="chat-footer" style="display: flex; gap: 5px;">-->
    <!--        &lt;!&ndash;        <input type="text" id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜å¹¶å›è½¦" onkeypress="handleKey(event)"&ndash;&gt;-->
    <!--        &lt;!&ndash;               style="flex: 1;">&ndash;&gt;-->
    <!--        <textarea id="chatInput" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜å¹¶å›è½¦" onkeypress="handleKey(event)" rows="1"-->
    <!--                  style="resize: none; overflow: hidden; min-height: 36px;"></textarea>-->
    <!--        <button id="sendBtn" onclick="clickSend()" class="btn btn-primary">å‘é€</button>-->
    <!--    </div>-->
    <div class="chat-footer" style="display: flex; gap: 5px;">
        <textarea id="chatInput" onkeypress="handleKey(event)" placeholder="è¯·è¾“å…¥æ‚¨çš„é—®é¢˜å¹¶å›è½¦" rows="1"
                  style="flex: 1; resize: none; overflow: hidden; min-height: 36px;"></textarea>
        <button class="btn btn-primary" id="sendBtn" onclick="clickSend()" style="width: 80px;">å‘é€</button>
    </div>
</div>
<!-- Bootstrap JS CDN -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        // âœ… è¾“å…¥æ¡†è‡ªåŠ¨è¡¥å…¨é¡¹ç›®ç¼–å·
        $('#project_code').on('input', function () {
            var query = $(this).val().trim();
            if (query.length >= 2) {
                $.ajax({
                    url: '/search_projects',
                    method: 'GET',
                    data: {query: query},
                    success: function (data) {
                        var suggestions = $('#autocomplete-suggestions');
                        suggestions.empty();

                        if (data.projects && data.projects.length > 0) {
                            data.projects.forEach(function (project) {
                                var suggestionItem = $('<div class="autocomplete-suggestion"></div>');
                                suggestionItem.attr('data-code', project.code);
                                suggestionItem.attr('data-segmented', project.has_segments ? 'true' : 'false');

                                var label = project.code + ' - ' + project.name + (project.has_segments ? 'ï¼ˆå«æ ‡æ®µï¼‰' : '');
                                suggestionItem.text(label);

                                suggestionItem.on('click', function () {
                                    $('#project_code').val(project.code);
                                    $('#project_id').val(project.id);
                                    suggestions.empty();

                                    $.ajax({
                                        url: '/get_segments/' + project.id,
                                        method: 'GET',
                                        success: function (data) {
                                            const segmentWrapper = $('#segment-wrapper');
                                            const segmentSelect = $('#sub_project_id');
                                            segmentSelect.empty().append('<option value="">-- è¯·é€‰æ‹©æ ‡æ®µ --</option>');

                                            if (data.subprojects && data.subprojects.length > 0) {
                                                data.subprojects.forEach(function (sp) {
                                                    segmentSelect.append(`<option value="${sp.id}">${sp.segment_name}</option>`);
                                                });
                                                segmentWrapper.show();
                                            } else {
                                                segmentWrapper.hide();
                                                // âœ… ç”¨æˆ·ä½“éªŒå¢å¼ºæç¤º
                                                alert('âœ… å½“å‰é¡¹ç›®æ²¡æœ‰æ ‡æ®µï¼Œå¯ç›´æ¥å¡«å†™æŠ•æ ‡ä¿¡æ¯ã€‚');
                                            }
                                        },
                                        error: function () {
                                            alert('âŒ è·å–æ ‡æ®µä¿¡æ¯å¤±è´¥ï¼Œè¯·ç¨åå†è¯•æˆ–è”ç³»ç®¡ç†å‘˜ã€‚');
                                        }
                                    });
                                });

                                suggestions.append(suggestionItem);
                            });
                        } else {
                            suggestions.append('<div class="autocomplete-suggestion">æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®</div>');
                        }
                    }
                });
            } else {
                $('#autocomplete-suggestions').empty();
            }
        });

        // âœ… æäº¤å‰æ ¡éªŒæ˜¯å¦é€‰æ‹©äº†æ ‡æ®µï¼ˆè‹¥è¯¥é¡¹ç›®æœ‰æ ‡æ®µï¼‰
        $('form').on('submit', function () {
            const segmentWrapper = $('#segment-wrapper');
            const segmentSelect = $('#sub_project_id');

            if (segmentWrapper.is(':visible') &&
                segmentSelect.children('option').length > 1 &&
                segmentSelect.val() === '') {
                alert('âš ï¸ è¯¥é¡¹ç›®å­˜åœ¨æ ‡æ®µï¼Œè¯·å…ˆé€‰æ‹©å…·ä½“æ ‡æ®µï¼');
                return false;
            }
        });
    });
</script>

<script>
    // å®¢æˆ·ç«¯è¡¨å•éªŒè¯
    $(document).ready(function () {
        $('#registrationForm').on('submit', function (event) {
            let isValid = true;

            // éªŒè¯æ‰‹æœºå·ç ï¼ˆ11ä½æ•°å­—ï¼‰
            let phone = $('#phone').val();
            let phonePattern = /^[0-9]{11}$/;
            if (!phonePattern.test(phone)) {
                isValid = false;
                $('#phone-error').removeClass('hidden');
            } else {
                $('#phone-error').addClass('hidden');
            }

            // éªŒè¯ç”µå­é‚®ç®±ï¼ˆå¿…é¡»æœ‰@ï¼Œä»¥.comç»“å°¾ï¼‰
            let email = $('#email').val();
            let emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,4}$/;
            if (!emailPattern.test(email) || !email.endsWith(".com")) {
                isValid = false;
                $('#email-error').removeClass('hidden');
            } else {
                $('#email-error').addClass('hidden');
            }

            // å¦‚æœéªŒè¯å¤±è´¥ï¼Œé˜»æ­¢è¡¨å•æäº¤
            if (!isValid) {
                event.preventDefault();
            }
        });
    });
</script>
<script>
    // è‡ªåŠ¨æ·¡å‡º flash æç¤ºæ¡†
    setTimeout(function () {
        const container = document.getElementById("flash-container");
        if (container) {
            container.style.transition = "opacity 2s ease";
            container.style.opacity = 0;

            // å†å»¶è¿Ÿé”€æ¯ DOM èŠ‚ç‚¹
            setTimeout(() => container.remove(), 2000);
        }
    }, 10000); // 10ç§’åå¼€å§‹æ·¡å‡º
</script>
<script>
    function toggleFAQ() {
        const box = document.getElementById('faqBubble');
        box.style.display = box.style.display === 'block' ? 'none' : 'block';
    }

    function toggleAnswer(el) {
        const answer = el.nextElementSibling;
        const icon = el.querySelector('span');
        const shown = answer.style.display === 'block';
        answer.style.display = shown ? 'none' : 'block' ;
        icon.textContent = shown ? '+' : 'â€“';
    }

    window.onload = function () {
        appendMessage("bot", "äº²çˆ±çš„å®¢æˆ·æ‚¨å¥½ï¼Œæˆ‘æ˜¯äº‘å—å›½åˆå»ºè®¾æ‹›æ ‡å’¨è¯¢å…¬å¸çš„AIæœºå™¨äººåŠ©æ‰‹ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆç–‘é—®å‘¢ï¼Ÿ");
    };

    function toggleChat() {
        const win = document.getElementById("chatWindow");
        const voiceBtns = document.getElementById("voice-control-buttons");  // âœ… æ­£ç¡®å£°æ˜ï¼

        if (win.style.display === "flex") {
            win.style.display = "none";
            voiceBtns.style.display = "none";
            fetch('/reset_chat', {method: 'POST'});
        } else {
            win.style.display = "flex";
            voiceBtns.style.display = "block";
        }
    }


    function handleKey(event) {
        if (event.key === "Enter") {
            const input = document.getElementById("chatInput");
            const message = input.value.trim();
            if (message) {
                appendMessage("user", message);
                input.value = "";

                // æ·»åŠ â€œæ­£åœ¨æ€è€ƒä¸­...â€çš„æç¤ºï¼Œå¹¶ä¿å­˜èŠ‚ç‚¹
                const placeholder = appendMessage("bot", "ğŸ¤– æ­£åœ¨æ€è€ƒä¸­...", true);

                fetch('/ask_deepseek', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({question: message})
                })
                    .then(res => res.json())
                    .then(data => {
                        if (data.answer) {
                            placeholder.querySelector(".bubble").textContent = data.answer;
                        } else {
                            placeholder.querySelector(".bubble").textContent = "âŒ æŠ±æ­‰ï¼Œæˆ‘æš‚æ—¶æ— æ³•å›ç­”è¿™ä¸ªé—®é¢˜ã€‚";
                        }
                    })
                    .catch(() => {
                        placeholder.querySelector(".bubble").textContent = "âš ï¸ è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚";
                    });

                // âœ… ä¸ç®¡å‘é€æˆåŠŸè¿˜æ˜¯å¤±è´¥ï¼Œå…ˆæ¸…ç©ºè¾“å…¥æ¡†å¹¶å½’ä½é«˜åº¦
                input.value = "";
                input.style.height = "36px";
                accumulatedTranscript = ""; // ğŸ§¹ å‘é€æˆåŠŸåï¼Œæ¸…ç©ºç´¯è®¡è¯­éŸ³æ–‡æœ¬

            }
        }
    }

    function clickSend() {
        if (isSpeaking) {
            stopRecognition(); // âœ… å¦‚æœæ­£åœ¨è¯´è¯ï¼Œç‚¹å‡»å‘é€æŒ‰é’®æ—¶è‡ªåŠ¨åœæ­¢è¯­éŸ³è¯†åˆ«
        }
        const eventEnter = new KeyboardEvent('keypress', {key: 'Enter'});
        handleKey(eventEnter);
    }


    function appendMessage(role, text, returnNode = false) {
        const container = document.getElementById("chatBody");
        const row = document.createElement("div");
        row.className = "msg-row " + role;

        const avatar = document.createElement("div");
        avatar.className = "avatar";
        avatar.textContent = role === "user" ? "æ‚¨" : "ğŸ¤–";

        const bubble = document.createElement("div");
        bubble.className = "bubble";
        bubble.textContent = text;

        row.appendChild(role === "user" ? bubble : avatar);
        row.appendChild(role === "user" ? avatar : bubble);
        container.appendChild(row);
        container.scrollTop = container.scrollHeight;
        return returnNode ? row : null;
    }

    function resetChat() {
        fetch('/reset_chat', {method: 'POST'});
        const chatBody = document.getElementById("chatBody");
        chatBody.innerHTML = '';
        appendMessage("bot", "äº²çˆ±çš„å®¢æˆ·æ‚¨å¥½ï¼Œæˆ‘æ˜¯äº‘å—å›½åˆå»ºè®¾æ‹›æ ‡å’¨è¯¢å…¬å¸çš„AIæœºå™¨äººåŠ©æ‰‹ï¼Œè¯·é—®æ‚¨æœ‰ä»€ä¹ˆç–‘é—®å‘¢ï¼Ÿ");
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const creditCodeInput = document.getElementById('credit_code');
        const illegalLetterError = document.getElementById('credit_code_illegal_letter_error');
        const specialCharError = document.getElementById('credit_code_special_char_error');
        const lengthError = document.getElementById('credit_code_length_error');
        const submitButton = document.getElementById('submit_button'); // æäº¤æŒ‰é’®è¦åŠ  id

        function cleanInput(value) {
            let upper = value.toUpperCase();
            let cleaned = '';
            let hasIllegalLetter = false;
            let hasSpecialChar = false;

            for (let i = 0; i < upper.length; i++) {
                const ch = upper[i];
                if ('IOZSV'.includes(ch)) {
                    hasIllegalLetter = true;
                    continue; // æ‹¦æˆªæ‰éæ³•å­—æ¯
                }
                if (!/[0-9A-Z]/.test(ch)) {
                    hasSpecialChar = true;
                    continue; // æ‹¦æˆªç‰¹æ®Šå­—ç¬¦
                }
                cleaned += ch;
            }

            return {
                cleaned,
                hasIllegalLetter,
                hasSpecialChar
            };
        }

        function validateCreditCode(value, flags) {
            const isLengthValid = value.length === 18;

            // éšè—æ‰€æœ‰æç¤º
            illegalLetterError.style.display = 'none';
            specialCharError.style.display = 'none';
            lengthError.style.display = 'none';

            let hasError = false;

            // æ˜¾ç¤ºéæ³•å­—æ¯é”™è¯¯
            if (flags.hasIllegalLetter) {
                illegalLetterError.style.display = 'block';
                hasError = true;
            }

            // æ˜¾ç¤ºç‰¹æ®Šå­—ç¬¦é”™è¯¯
            if (flags.hasSpecialChar) {
                specialCharError.style.display = 'block';
                hasError = true;
            }

            // æ˜¾ç¤ºé•¿åº¦ä¸å¤Ÿé”™è¯¯
            if (value.length > 0 && !isLengthValid) {
                lengthError.style.display = 'block';
                hasError = true;
            }

            if (submitButton) {
                submitButton.disabled = hasError;
            }
        }

        if (creditCodeInput) {
            creditCodeInput.addEventListener('input', function () {
                const result = cleanInput(this.value);
                this.value = result.cleaned.slice(0, 18); // é™åˆ¶æœ€å¤§é•¿åº¦
                validateCreditCode(this.value, result);
            });

            creditCodeInput.addEventListener('paste', function (event) {
                event.preventDefault(); // é˜»æ­¢é»˜è®¤ç²˜è´´
                const pasteData = (event.clipboardData || window.clipboardData).getData('text');
                const result = cleanInput(pasteData);
                this.value = result.cleaned.slice(0, 18);
                validateCreditCode(this.value, result);
            });
        }
    });
</script>
<!-- âœ… å®æ—¶è¯­éŸ³è¯†åˆ«ç»“æœæ˜¾ç¤ºæ¡† -->
<div id="transcript-box" style="position: fixed; bottom: 190px; right: 30px; background: rgba(255,255,255,0.85);
            padding: 8px 12px; border-radius: 8px; font-size: 14px; max-width: 300px; color: #333;
            z-index: 1001; display: none;">
</div>
<!-- âœ… åªæœ‰ä¸€ä¸ªè¯­éŸ³åˆ‡æ¢æŒ‰é’® -->
<div id="voice-control-buttons" style="display: none; position: fixed; bottom: 130px; right: 30px; z-index: 1002;">
    <button class="btn btn-success" id="voice-toggle-btn" onclick="toggleVoiceChat()">ğŸ™ï¸ å¼€å§‹è¯´è¯</button>
</div>
<script>
    let recognition = null;
    let isSpeaking = false;
    let accumulatedTranscript = ""; // ğŸ“ ç´¯åŠ æ•´ä¸ªè¯´è¯è¿‡ç¨‹çš„å†…å®¹
    function toggleVoiceChat() {
        if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
            alert("âŒ å½“å‰æµè§ˆå™¨ä¸æ”¯æŒè¯­éŸ³è¯†åˆ«ï¼Œè¯·ç”¨ Chrome/Edge");
            return;
        }

        if (!isSpeaking) {
            recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
            // âœ… ç«‹åˆ»åŒæ­¥è¾“å…¥æ¡†å·²æœ‰å†…å®¹åˆ°accumulatedTranscript
            const inputBox = document.getElementById("chatInput");
            accumulatedTranscript = inputBox.value || "";
            recognition.lang = 'zh-CN';
            recognition.interimResults = true;

            recognition.onresult = function (event) {
                let finalTranscript = "";
                let interimTranscript = "";

                for (let i = event.resultIndex; i < event.results.length; i++) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript;
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }

                accumulatedTranscript += finalTranscript;  // åªåœ¨ isFinal ç´¯åŠ 

                const inputBox = document.getElementById("chatInput");
                inputBox.value = accumulatedTranscript + interimTranscript; // å·²å®Œæˆ + ä¸´æ—¶è¯†åˆ«
                // inputBox.style.height = 'auto';
                // inputBox.style.height = inputBox.scrollHeight + 'px';
                inputBox.dispatchEvent(new Event('input')); // âœ… æ´¾å‘ inputäº‹ä»¶ï¼Œè§¦å‘è‡ªé€‚åº”
            };


            recognition.onerror = function (event) {
                console.error("è¯­éŸ³è¯†åˆ«é”™è¯¯:", event.error);
                stopRecognition();
            };

            recognition.onend = function () {
                console.log("ğŸ™ï¸ æœ¬è½®è¯†åˆ«ç»“æŸ");
                if (isSpeaking) {
                    console.log("âœ… è‡ªåŠ¨é‡å¯ç›‘å¬ä¸­...");
                    recognition.start();  // ç»­å¬
                } else {
                    console.log("ğŸ›‘ ç”¨æˆ·å·²æ‰‹åŠ¨åœæ­¢ï¼Œä¸å†ç»­å¬");
                    // âœ… åªæœ‰ç”¨æˆ·æ‰‹åŠ¨ç‚¹å‡»ç»“æŸæ—¶ï¼Œæ‰è°ƒç”¨çœŸæ­£çš„stopRecognitioné€»è¾‘ï¼
                    finalizeInput();
                }
            };

            recognition.start();
            isSpeaking = true;
            updateVoiceButton(true);
            console.log("âœ… å¼€å§‹è¯­éŸ³è¯†åˆ«ï¼");
        } else {
            stopRecognition();
        }
    }

    function finalizeInput() {
        const inputBox = document.getElementById("chatInput");
        if (accumulatedTranscript.trim() !== "") {
            inputBox.value = accumulatedTranscript;

            // ä¸è‡ªåŠ¨å‘é€ï¼åªå¡«åˆ°è¾“å…¥æ¡†ï¼
            // accumulatedTranscript = ""; // æ¸…ç©ºï¼Œä¸ºä¸‹ä¸€æ¬¡è¯†åˆ«åšå‡†å¤‡

            // è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            inputBox.style.height = 'auto';
            inputBox.style.height = inputBox.scrollHeight + 'px';
        }
    }

    function stopRecognition() {
        if (recognition) {
            recognition.stop();
            recognition = null;
        }
        isSpeaking = false;
        updateVoiceButton(false);
        console.log("ğŸ›‘ è¯­éŸ³è¯†åˆ«å·²åœæ­¢ï¼");

        // // âœ… ç»Ÿä¸€æäº¤ç´¯è®¡çš„å†…å®¹
        // if (accumulatedTranscript.trim() !== "") {
        //     const inputBox = document.getElementById("chatInput");
        //     inputBox.value = accumulatedTranscript;
        //
        //     const eventEnter = new KeyboardEvent('keypress', {key: 'Enter'});
        //     handleKey(eventEnter);
        //
        //     accumulatedTranscript = ""; // ğŸ§¹ æ¸…ç©ºï¼Œä¸ºä¸‹ä¸€æ¬¡è¯†åˆ«åšå‡†å¤‡
        // }
    }

    function updateVoiceButton(speaking) {
        const btn = document.getElementById("voice-toggle-btn");
        if (speaking) {
            btn.textContent = "ğŸ›‘ ç»“æŸè¯´è¯";
            btn.className = "btn btn-danger";
        } else {
            btn.textContent = "ğŸ™ï¸ å¼€å§‹è¯´è¯";
            btn.className = "btn btn-success";
        }
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const chatInput = document.getElementById('chatInput');
        chatInput.addEventListener('input', function () {
            this.style.height = 'auto'; // å…ˆå¤ä½é«˜åº¦
            this.style.height = (this.scrollHeight) + "px"; // å†æ ¹æ®å†…å®¹è°ƒæ•´
        });
    });

</script>

<script>
document.getElementById("autocomplete-suggestions").addEventListener("click", function (e) {
    const item = e.target.closest(".autocomplete-suggestion");
    if (!item) return;

    const code = item.getAttribute("data-code");
    const isSegmented = item.getAttribute("data-segmented") === "true";

    document.getElementById("project_code").value = code;

    const segmentWrapper = document.getElementById("segment-wrapper");
    const segmentSelect = document.getElementById("sub_project_id");

    if (isSegmented) {
        segmentWrapper.style.display = "block";
        segmentSelect.disabled = false;
        segmentSelect.setAttribute("required", "required");
    } else {
        segmentWrapper.style.display = "none";
        segmentSelect.disabled = true;
        segmentSelect.removeAttribute("required");
            // âœ… å¼ºåˆ¶è®¾ç½®é»˜è®¤é€‰ä¸­é¡¹
        segmentSelect.selectedIndex = 0;
    }
});
</script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const btn = document.querySelector('button[type="submit"]');
    if (btn) {
        btn.addEventListener("click", () => {
            console.log("âœ… æŒ‰é’®ç‚¹å‡»äº‹ä»¶è§¦å‘äº†");
        });
    } else {
        console.error("âŒ æ‰¾ä¸åˆ°æäº¤æŒ‰é’®ï¼");
    }

    const form = document.querySelector("#registrationForm");
    if (form) {
        form.addEventListener("submit", (e) => {
            console.log("ğŸŸ¢ è¡¨å•å‡†å¤‡æäº¤");
        });
    } else {
        console.error("âŒ æ‰¾ä¸åˆ°è¡¨å•ï¼");
    }
});
</script>
</body>


</body>
</html>



