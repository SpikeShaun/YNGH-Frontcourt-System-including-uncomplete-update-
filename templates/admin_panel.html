<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{{ url_for('static', filename='bid.png') }}" type="image/png">
    <title>åå°ç®¡ç†é¢æ¿ - äº‘å—å›½åˆæ‹›æ ‡ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            /*background: url("../static/img/admin_panel.jpg") no-repeat center center fixed;*/
            background-size: cover;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .panel {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 1100px;
            margin: 5vh auto;
            box-shadow: 0 0 16px rgba(0, 0, 0, 0.2);
            position: relative;

            /* æ–°å¢ï¼šé™åˆ¶æœ€å¤§é«˜åº¦ + æ»šåŠ¨æ¡ */
            max-height: 90vh;
            overflow-y: auto;
        }


        .project-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-logout-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .projects-list {
            max-height: 850px;
            overflow-y: auto;
        }

        .search-box {
            width: 100%;
            max-width: 250px;
            margin-left: auto;
        }


    </style>
    <style>
        @keyframes flash-once {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
            }
        }

        .flash-once {
            animation: flash-once 1s ease-in-out;
        }
    </style>
    <style>
.fixed-top-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 10px 20px;
    background-color: white;
    border-bottom: 1px solid #ccc;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* æ§åˆ¶å¼¹å‡ºèœå•ä¸å æ®ä¸»æ å®½åº¦ï¼Œä»…ä½œä¸ºå³æµ®å±‚å¼¹å‡º */
.more-dropdown-menu {
    min-width: 250px;
    margin-top: 10px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.more-dropdown-menu .dropdown-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
}


        .fixed-top-bar .btn {
            min-width: 200px;
        }

        /* å“åº”å¼ï¼šå°å±å¹•æ”¹ä¸ºç«–æ’å¸ƒå±€ */
        @media (max-width: 768px) {
            .fixed-top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .panel {
                margin-top: 160px !important; /* ä¿è¯ panel ä¸è¢«æŒ‰é’®æ é®æŒ¡ */
            }
        }

        /* åŸå§‹ margin-top è°ƒæ•´ä»¥é¿å¼€ fixed é¡¶æ  */
        .panel {
            margin-top: 100px; /* ç•™å‡ºé¡¶éƒ¨æŒ‰é’®æ ç©ºé—´ */
            margin-bottom: 5vh;
        }
    </style>
</head>
<body>

<div class="fixed-top-bar bg-light p-2 border-bottom d-flex justify-content-between align-items-center">
    <!-- å·¦ä¾§â€œæ›´å¤šåŠŸèƒ½â€ä¸‹æ‹‰ -->
    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="moreDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            ğŸ“¦ æ›´å¤šåŠŸèƒ½
        </button>
        <ul class="dropdown-menu dropdown-menu-start more-dropdown-menu" aria-labelledby="moreDropdown">
            <li><a class="dropdown-item" href="{{ url_for('view_mail_logs') }}">ğŸ“¬ æŸ¥çœ‹å®šæ—¶æ±‡æŠ¥é‚®ä»¶è®°å½•</a></li>
            <li><a class="dropdown-item" href="{{ url_for('manage_leaders') }}">ğŸ‘¥ ç®¡ç†é¡¹ç›®ç»„é•¿</a></li>
            <li><button class="dropdown-item" id="backupToOssBtn">ğŸ—„ï¸ æ‰‹åŠ¨å¤‡ä»½æ•°æ®åˆ°äº‘ç›˜</button></li>
                <!-- âœ… æ–°å¢å¯¼å‡ºæŒ‰é’® -->
            <li>
                <a class="dropdown-item text-success" href="{{ url_for('export_project_summary') }}">
                    ğŸ“Š å¯¼å‡ºé¡¹ç›®ç»Ÿè®¡æ€»è¡¨
                </a>
            </li>
            <li><button class="dropdown-item text-danger" onclick="confirmCleanup('uploads')">ğŸ§¹ æ¸…é™¤æœ¬åœ°é¡¹ç›®æ–‡ä»¶</button></li>
            <li><button class="dropdown-item text-danger" onclick="confirmCleanup('downloads')">ğŸ§¹ æ¸…é™¤æœ¬åœ°ç™»è®°è¡¨å’Œç»Ÿè®¡è¡¨</button></li>
        </ul>
    </div>

    <!-- å³ä¾§é€€å‡º -->
    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">é€€å‡ºç™»å½•</a>
</div>



<div class="panel">
    <!-- âœ… æ’å…¥è¿™é‡Œï¼šæ˜¾ç¤º flash æ¶ˆæ¯ -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show flash-message flash-once" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}


    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <h3 class="mb-0">ğŸ“Š é¡¹ç›®ä¸æŠ•æ ‡å®¢æˆ·ç®¡ç†</h3>
        </div>
        <div class="col-md-6 text-end">
            <input type="text" id="search-project" class="form-control d-inline-block w-auto"
                   placeholder="æœç´¢é¡¹ç›®åç§°æˆ–ç¼–å·..." style="max-width: 250px;">
        </div>
    </div>


    <!-- âœ… æ–°å¢ï¼šæŒ‰æˆªæ­¢çŠ¶æ€ + ç»„é•¿å§“åç­›é€‰ï¼ˆå¯ç»„åˆï¼‰ -->
    <div class="row mb-3 px-3 align-items-end">
        <div class="col-md-4">
            <label for="filter-deadline" class="form-label">æŒ‰æ—¶é—´çŠ¶æ€ç­›é€‰</label>
            <select class="form-select" id="filter-deadline">
                <option value="all">å…¨éƒ¨é¡¹ç›®</option>
                <option value="not_started">æœªå¼€å§‹</option>
                <option value="in_progress">è¿›è¡Œä¸­</option>
                <option value="ended">å·²æˆªæ­¢</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filter-leader" class="form-label">æŒ‰é¡¹ç›®ç»„é•¿ç­›é€‰</label>
            <div class="position-relative">
                <input type="text" class="form-control" id="filter-leader" placeholder="è¾“å…¥ç»„é•¿å§“å...">
                <div id="leader-suggestions" class="list-group position-absolute w-100"
                     style="z-index: 10; max-height: 240px; overflow-y: auto; display: none;"></div>
            </div>

        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary mt-3 w-100" id="clear-filters">æ¸…é™¤ç­›é€‰</button>
        </div>
    </div>

    <!-- å†…å®¹å·¦å³åˆ†æ  -->
    <div class="row">
        <!-- å·¦æ ï¼šæ·»åŠ æ–°é¡¹ç›® -->
        <div class="col-md-4 mb-3">
            <h4 class="mb-3">ğŸ“¤ æ·»åŠ æ–°é¡¹ç›®</h4>

            <form id="add-project-form" method="POST" action="{{ url_for('add_project') }}" enctype="multipart/form-data" class="row g-3">
                <input type="hidden" name="redirect_url" value="{{ request.path }}">
                <input type="hidden" id="is_segmented" name="is_segmented" value="false">
                <input type="hidden" id="segment-count" name="segment_count" value="0">

                <div class="col-12">
                    <label class="form-label">é¡¹ç›®åç§°</label>
                    <input type="text" class="form-control" name="name"
                           value="{{ session.get('project_form_data', {}).get('name', '') }}" required>
                </div>
                <div class="col-12">
                    <label class="form-label">é¡¹ç›®ç¼–å·</label>
                    <input type="text" class="form-control" name="code"
                           value="{{ session.get('project_form_data', {}).get('code', '') }}" required>
                </div>

                <div class="col-12">
                    <label class="form-label">é‡‡è´­äºº</label>
                    <input type="text" class="form-control" name="purchaser"
                           value="{{ session.get('project_form_data', {}).get('purchaser', '') }}" required>
                </div>

                <div class="col-12">
                    <label class="form-label">é‡‡è´­é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" step="0.01" class="form-control" name="budget_amount"
                           value="{{ session.get('project_form_data', {}).get('budget_amount', '0.00') }}" required>
                </div>


                <div class="col-12">
                    <label class="form-label">æ˜¯å¦åŒ…å«ä¸‹è¾–æ ‡æ®µ</label>
                    <select class="form-select" id="has-subprojects" name="has_subprojects">
                        <option value="no" selected>å¦</option>
                        <option value="yes">æ˜¯</option>
                    </select>
                </div>

                <!-- âœ… é¡¹ç›®çº§æ—¶é—´å­—æ®µï¼Œä»…åœ¨æ— æ ‡æ®µæ—¶æ˜¾ç¤º -->
                <div class="col-12" id="project-time-section">
                    <div class="mb-2">
                        <label class="form-label">æ–‡ä»¶è·å–å¼€å§‹æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" name="start_time"
                               value="{{ session.get('project_form_data', {}).get('start_time', '') }}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">æ–‡ä»¶è·å–æˆªæ­¢æ—¶é—´</label>
                        <input type="datetime-local" class="form-control" name="deadline"
                               value="{{ session.get('project_form_data', {}).get('deadline', '') }}">
                    </div>
                    <div id="deadline-hint" class="text-danger small mt-1 d-none"></div>
                </div>

                <!-- âœ… é¡¹ç›®ä¿è¯é‡‘ -->
                <div class="col-12" id="project-deposit-section">
                    <label class="form-label">ä¿è¯é‡‘é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" step="0.01" class="form-control" name="deposit_amount"
                           value="{{ session.get('project_form_data', {}).get('deposit_amount', '0.00') }}">
                </div>



                <div class="col-12">
                    <label class="form-label">é¡¹ç›®ç»„é•¿å§“åï¼ˆå¿…å¡«ï¼‰</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="leader-name" name="leader_name"
                               placeholder="è¾“å…¥å§“åè¿›è¡Œæ¨¡ç³ŠåŒ¹é…"
                               value="{{ session.get('project_form_data', {}).get('leader_name', '') }}" required>
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#leader-list">ğŸ“‚ é€‰æ‹©
                        </button>
                    </div>
                    <div class="collapse mt-1" id="leader-list">
                        <div class="list-group" id="leader-options" style="max-height: 240px; overflow-y: auto;"></div>
                    </div>
                    <input type="hidden" name="leader_email" id="leader-email"
                           value="{{ session.get('project_form_data', {}).get('leader_email', '') }}">
                </div>

                <div class="col-12">
                    <label class="form-label">é€‰æ‹©é¡¹ç›®ç»„æˆå‘˜ï¼ˆéå¿…å¡«ï¼‰ï¼ˆå¯å¤šé€‰ï¼‰</label>
                    <div class="input-group">
                        <input type="text" id="member-search" class="form-control"
                               placeholder="è¾“å…¥å§“åè¿›è¡Œæ¨¡ç³Šæœç´¢">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-member-list">ğŸ“‚ é€‰æ‹©</button>
                    </div>
                    <div id="member-suggestions" class="list-group mt-1"
                         style="z-index: 10; display: none; max-height: 200px; overflow-y: auto;"></div>
                    <div id="selected-members" class="mt-2 d-flex flex-wrap gap-2"></div>
                    <input type="hidden" name="member_ids" id="member-ids"
                           value="{{ session.get('project_form_data', {}).get('member_ids', '') }}">
                </div>

                <!-- æ·»åŠ åœ¨æ­¤å¤„ -->
                <div id="subproject-section" class="col-12 mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label">ğŸ“¦ æ·»åŠ æ ‡æ®µ</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSubprojectRow()">â• æ·»åŠ æ ‡æ®µ</button>
                    </div>
                    <div id="subproject-list-wrapper" class="mt-3"></div>
                </div>

                <!-- éšè—åŸŸå¿…é¡»ä¹Ÿåœ¨ form ä¸­ -->
                <input type="hidden" name="segment_count" id="segment_count" value="0">



               <!-- âœ… é¡¹ç›®çº§æ–‡ä»¶ä¸Šä¼ åŒºåŸŸï¼ˆä»…å½“ä¸åŒ…å«æ ‡æ®µæ—¶æ˜¾ç¤ºï¼‰ -->
                <div class="col-12" id="project-file-upload-group">
                    <label class="form-label">æ‹›æ ‡æ–‡ä»¶ï¼ˆæœ€å¤§50MBï¼Œä»…æ”¯æŒPDF/Word/zip/rarï¼‰</label>
                    <input type="file" class="form-control" name="file_upload" accept=".pdf,.doc,.docx,.zip,.rar" required>
                    <div id="file-size-error" class="text-danger small mt-1 d-none">âŒ æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 50MB</div>
                </div>


                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success w-100">â• æ·»åŠ é¡¹ç›®</button>
                </div>
            </form>
        </div>

        <!-- å³æ ï¼šé¡¹ç›®åˆ—è¡¨ -->
        <div class="col-md-8 position-relative" style="min-height: 600px;">

           <!-- æ ‡é¢˜è¡Œï¼šåªæ˜¾ç¤ºâ€œé¡¹ç›®åˆ—è¡¨â€ -->
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h4 class="mb-0">ğŸ‘¨â€ğŸ’» é¡¹ç›®åˆ—è¡¨</h4>
            </div>

            <!-- ç¬¬äºŒè¡Œï¼šå·¦ä¾§æ˜¾ç¤ºæ•°é‡ï¼Œå³ä¾§æ’åºé€‰æ‹© -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div id="project-count" class="text-muted">å½“å‰å…±æœ‰ {{ total_count }} ä¸ªé¡¹ç›®</div>
                <div>
                    <label for="sort-mode" class="form-label mb-0 me-2">æ’åºæ–¹å¼</label>
                    <select id="sort-mode" class="form-select form-select-sm d-inline-block w-auto" onchange="changeSortMode()">
                        <option value="code_asc" {% if sort_mode == 'code_asc' %}selected{% endif %}>é¡¹ç›®ç¼–å·å‡åº</option>
                        <option value="code_desc" {% if sort_mode == 'code_desc' %}selected{% endif %}>é¡¹ç›®ç¼–å·é™åº</option>
                        <option value="created_desc" {% if sort_mode == 'created_desc' %}selected{% endif %}>æ·»åŠ é¡ºåº</option>
                    </select>
                </div>
            </div>

            <div class="projects-list mb-5 pb-5">
                {% for project in projects %}
                    <div class="project-box">
                        <h5>ğŸ“ é¡¹ç›®ç¼–å·ï¼š{{ project.code }}</h5>
                       <p class="mb-1">
                            <strong>åç§°ï¼š</strong>{{ project.name }} &nbsp;&nbsp;
                            <strong>é¡¹ç›®ç¼–å·ï¼š</strong>{{ project.code }}
                        </p>
                        <p class="mb-1">
                            <strong>é‡‡è´­äººï¼š</strong>{{ project.purchaser }} &nbsp;&nbsp;
                            <strong>é‡‡è´­é‡‘é¢ï¼š</strong>Â¥ {{ project.budget_amount }} å…ƒ
                        </p>
                        <p class="mb-1">
                            <strong>å¼€å§‹æ—¶é—´ï¼š</strong>{{ project.start_time.strftime('%Y-%m-%d %H:%M') }} &nbsp;&nbsp;
                            <strong>æˆªæ­¢æ—¶é—´ï¼š</strong>{{ project.deadline.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                        <p class="mb-1">
                            <strong>é¡¹ç›®ç»„é•¿ï¼š</strong>{{ project.leader_email}} &nbsp;&nbsp;
                            <strong>é¡¹ç›®ç»„å‘˜ï¼š</strong>{{ project.members }}
                        </p>
                        {% if project.sub_projects %}
                            {% for sub in project.sub_projects %}
                            <div class="border-start ps-3 mb-2">
                                <p>
                                    <strong>ğŸ“Œ æ ‡æ®µï¼š</strong>{{ sub.name }}<br>
                                    æ–‡ä»¶è·å–æ—¶é—´ï¼š{{ sub.start_time.strftime('%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†') }} ~ {{ sub.deadline.strftime('%Yå¹´%mæœˆ%dæ—¥%Hæ—¶%Måˆ†') }}<br>
                                    ä¿è¯é‡‘ï¼šÂ¥ {{ sub.deposit_amount }} å…ƒ<br>
                                    ä¸Šä¼ æ–‡ä»¶ï¼š{{ sub.file_path or "æš‚æ— " }}
                                </p>
                                <div class="mb-2">
                                    <a href="{{ url_for('view_bids', project_id=sub.project_id) }}" class="btn btn-sm btn-primary">ğŸ“‚ æŸ¥çœ‹å®¢æˆ·ç™»è®°</a>
                                    <a href="{{ url_for('edit_project', project_id=sub.id) }}" class="btn btn-sm btn-warning">âœï¸ ç¼–è¾‘æ ‡æ®µ</a>
                                    <form action="{{ url_for('delete_sub_project', sub_project_id=sub.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡æ®µï¼Ÿ')">ğŸ—‘ï¸ åˆ é™¤</button>
                                    </form>
                                    <!-- âœ… æ ‡æ®µä¸‹æŒ‰é’® -->
                                    <a href="#" id="export-btn-project-{{ project.id }}-sub-{{ sub.id }}"
                                       onclick="exportRegistrationForms({{ project.id }}, 'project-{{ project.id }}-sub-{{ sub.id }}')"
                                       class="btn btn-sm btn-info">ğŸ“„ å¯¼å‡ºç™»è®°è¡¨ï¼ˆå‹ç¼©åŒ…ï¼‰</a>

                                   <a href="{{ url_for('export_excel', sub_project_id=sub.id) }}" class="btn btn-sm btn-success">ğŸ“Š å¯¼å‡ºç»Ÿè®¡è¡¨</a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">æš‚æ— æ ‡æ®µä¿¡æ¯ã€‚</p>
                            <div class="mb-2">
                                <a href="{{ url_for('view_bids', project_id=project.id) }}" class="btn btn-sm btn-primary">ğŸ“‚ æŸ¥çœ‹å®¢æˆ·ç™»è®°</a>
                                <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-sm btn-warning">âœï¸ ç¼–è¾‘é¡¹ç›®</a>
                                <form action="{{ url_for('delete_project', project_id=project.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ•´ä¸ªé¡¹ç›®ï¼Ÿ')">ğŸ—‘ï¸ åˆ é™¤é¡¹ç›®</button>
                                </form>
                                <!-- âœ… æ— æ ‡æ®µé¡¹ç›®æŒ‰é’® -->
                                <a href="#" id="export-btn-project-{{ project.id }}"
                                   onclick="exportRegistrationForms({{ project.id }}, 'project-{{ project.id }}')"
                                   class="btn btn-sm btn-info">ğŸ“„ å¯¼å‡ºç™»è®°è¡¨ï¼ˆå‹ç¼©åŒ…ï¼‰</a>
                                <a href="{{ url_for('export_excel_project', project_id=project.id) }}" class="btn btn-sm btn-success">ğŸ“Š å¯¼å‡ºç»Ÿè®¡è¡¨</a>
                            </div>
                        {% endif %}

                    </div>
                    {% endfor %}

            </div>
           <!-- âœ… å›ºå®šåœ¨ .col-md-8 å†…åº•éƒ¨ -->
            <nav class="position-absolute bottom-0 start-0 w-100 py-3 bg-white border-top">
              <ul class="pagination justify-content-center mb-0">
                {% for p in range(1, (total_count // per_page) + (1 if total_count % per_page else 0) + 1) %}
                  <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('admin_panel', sort_mode=sort_mode, page=p) }}">{{ p }}</a>
                  </li>
                {% endfor %}
              </ul>
            </nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('search-project').addEventListener('input', function (e) {
        const searchQuery = e.target.value.trim();
        const list = document.querySelector('.projects-list');
        const count = document.getElementById("project-count");

        if (searchQuery === "") {
            window.location.reload();
        } else {
            fetch(`/search_projects?query=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    if (data.projects.length > 0) {
                        const results = data.projects.map(project => {
                            const subProjectsHTML = project.sub_projects && project.sub_projects.length > 0
                                ? project.sub_projects.map(sub => `
                                    <div class="border-start ps-3 mb-2">
                                        <p>
                                            <strong>ğŸ“Œ æ ‡æ®µï¼š</strong>${sub.name}<br>
                                            æ–‡ä»¶è·å–æ—¶é—´ï¼š${sub.start_time} ~ ${sub.deadline}<br>
                                            ä¿è¯é‡‘ï¼šÂ¥ ${sub.deposit_amount} å…ƒ<br>
                                            ä¸Šä¼ æ–‡ä»¶ï¼š${sub.file_path || "æš‚æ— "}
                                        </p>
                                        <div class="mb-2">
                                            <a href="/admin/project/${project.id}/bids/${sub.id}" class="btn btn-sm btn-primary">ğŸ“‚ æŸ¥çœ‹å®¢æˆ·ç™»è®°</a>
                                            <a href="/admin/edit_sub_project/${sub.id}" class="btn btn-sm btn-warning">âœï¸ ç¼–è¾‘æ ‡æ®µ</a>
                                            <form action="/admin/delete_sub_project/${sub.id}" method="POST" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡æ®µï¼Ÿ')">ğŸ—‘ï¸ åˆ é™¤</button>
                                            </form>
                                            <a href="/admin/subproject/${sub.id}/export_excel" class="btn btn-sm btn-success">ğŸ“Š å¯¼å‡ºç»Ÿè®¡è¡¨</a>
                                            <a href="#" onclick="exportRegistrationForms(${sub.id})" class="btn btn-sm btn-info">ğŸ“„ å¯¼å‡ºç™»è®°è¡¨</a>
                                        </div>
                                    </div>
                                `).join('')
                                : `<p class="text-muted">æš‚æ— æ ‡æ®µä¿¡æ¯ã€‚</p>`;

                            return `
                                <div class="project-box">
                                    <h5>ğŸ“ é¡¹ç›®ç¼–å·ï¼š${project.code}</h5>
                                    <p>åç§°ï¼š${project.name}</p>
                                    ${subProjectsHTML}
                                </div>
                            `;
                        }).join('');

                        list.innerHTML = results;
                        count.textContent = `å½“å‰å…±æœ‰ ${data.projects.length} ä¸ªé¡¹ç›®`;
                    } else {
                        list.innerHTML = `<p class="text-muted">ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®è®°å½•ã€‚</p>`;
                        count.textContent = `å½“å‰å…±æœ‰ 0 ä¸ªé¡¹ç›®`;
                    }
                });
        }
    });
</script>

<script>
    // è®© flash æ¶ˆæ¯åœ¨é¡µé¢åŠ è½½å 5 ç§’è‡ªåŠ¨æ·¡å‡º
    window.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function (msg) {
                // ä½¿ç”¨ Bootstrap è‡ªå¸¦çš„æ–¹æ³•è®©å®ƒæ¶ˆå¤±
                let alert = bootstrap.Alert.getOrCreateInstance(msg);
                alert.close();
            });
        }, 5000); // 5000æ¯«ç§’ = 5ç§’
    });
</script>

<script>
    function exportRegistrationForms(projectId, btnKey) {
        const exportBtn = document.getElementById(`export-btn-${btnKey}`);
        if (!exportBtn) return;

        exportBtn.disabled = true;
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = 'â³ æ­£åœ¨æ‰“åŒ…ï¼Œè¯·ç¨å€™...';

        // âœ… ç»Ÿä¸€è°ƒç”¨åç«¯è·¯ç”±ï¼ˆé¡¹ç›®çº§åˆ«ï¼‰
        window.location.href = `/export_registration_forms_project/${projectId}`;

        setTimeout(() => {
            exportBtn.disabled = false;
            exportBtn.innerHTML = originalText;
        }, 2000);
    }
</script>


<script>
    const leaderInput = document.getElementById("leader-name");
    const emailHidden = document.getElementById("leader-email");
    const listBox = document.getElementById("leader-options");
    const collapseBox = document.getElementById("leader-list");
    const collapseBtn = document.querySelector("[data-bs-target='#leader-list']");

    let debounceTimer = null;

    function loadLeaders(keyword = "") {
        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                listBox.innerHTML = "";

                if (data.length === 0) {
                    const none = document.createElement("div");
                    none.className = "list-group-item text-muted";
                    none.textContent = "æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®ç»„é•¿";
                    listBox.appendChild(none);
                    return;
                }

                data.forEach(item => {
                    const isAlreadySelectedMember = selectedMembers.some(m => m.email === item.email);
                    if (isAlreadySelectedMember) return;  // âœ… å¦‚æœè¿™ä¸ªäººå·²ç»æ˜¯æˆå‘˜äº†ï¼Œå°±ä¸æ˜¾ç¤ºä¸ºç»„é•¿å€™é€‰

                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.type = "button";
                    btn.textContent = item.name + "ï¼ˆ" + item.email + "ï¼‰";
                    btn.onclick = () => {
                        leaderInput.value = item.name;
                        emailHidden.value = item.email;

                        // ğŸ‘‡ æ›´æ–°æˆå‘˜åˆ—è¡¨ï¼Œæ’é™¤æ–°ç»„é•¿
                        loadMemberSuggestions(memberSearchInput.value.trim());

                        bootstrap.Collapse.getInstance(collapseBox)?.hide();
                    };
                    listBox.appendChild(btn);
                });

            });
    }

    // ç›‘å¬è¾“å…¥æ¡†è¾“å…¥
    leaderInput.addEventListener("input", () => {
        const keyword = leaderInput.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (keyword) {
                loadLeaders(keyword);
                bootstrap.Collapse.getOrCreateInstance(collapseBox).show();
            } else {
                bootstrap.Collapse.getOrCreateInstance(collapseBox).hide();
            }
        }, 200);
    });

    // ğŸ“‚æŒ‰é’®ç‚¹å‡»ï¼šå§‹ç»ˆåŠ è½½å…¨éƒ¨ç»„é•¿ + å±•å¼€
    collapseBtn.addEventListener("click", () => {
        loadLeaders("");  // ğŸ‘‰ åŠ è½½æ‰€æœ‰
        bootstrap.Collapse.getOrCreateInstance(collapseBox).toggle();
    });

    // åˆå§‹åŒ–æ—¶ä¸åŠ è½½ï¼ˆæ ¹æ®ä½ è¦æ±‚ï¼‰
</script>


<script>
    function applyFilters() {
        const deadlineVal = document.getElementById('filter-deadline').value;
        const leaderVal = document.getElementById('filter-leader').value.trim();
        const params = new URLSearchParams();
        const list = document.querySelector('.projects-list');
        const count = document.getElementById("project-count");

        if (deadlineVal !== 'all') {
            params.append('deadline', deadlineVal);
        }
        if (leaderVal) {
            params.append('leader', leaderVal);
        }

        fetch(`/filter_projects?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.projects.length === 0) {
                    list.innerHTML = '<p class="text-muted">ğŸ” æœªæ‰¾åˆ°åŒ¹é…çš„é¡¹ç›®è®°å½•ã€‚</p>';
                    count.textContent = `å½“å‰å…±æœ‰ 0 ä¸ªé¡¹ç›®`;
                    return;
                }

                list.innerHTML = data.projects.map(project => {
                    const subProjectsHTML = project.sub_projects && project.sub_projects.length > 0
                        ? project.sub_projects.map(sub => `
                            <div class="border-start ps-3 mb-2">
                                <p>
                                    <strong>ğŸ“Œ æ ‡æ®µï¼š</strong>${sub.name}<br>
                                    æ–‡ä»¶è·å–æ—¶é—´ï¼š${sub.start_time} ~ ${sub.deadline}<br>
                                    ä¿è¯é‡‘ï¼šÂ¥ ${sub.deposit_amount} å…ƒ<br>
                                    ä¸Šä¼ æ–‡ä»¶ï¼š${sub.file_path || "æš‚æ— "}
                                </p>
                                <div class="mb-2">
                                    <a href="/admin/project/${project.id}/bids/${sub.id}" class="btn btn-sm btn-primary">ğŸ“‚ æŸ¥çœ‹å®¢æˆ·ç™»è®°</a>
                                    <a href="/admin/edit_sub_project/${sub.id}" class="btn btn-sm btn-warning">âœï¸ ç¼–è¾‘æ ‡æ®µ</a>
                                    <form action="/admin/delete_sub_project/${sub.id}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('ç¡®å®šåˆ é™¤æ­¤æ ‡æ®µï¼Ÿ')">ğŸ—‘ï¸ åˆ é™¤</button>
                                    </form>
                                    <a href="/admin/subproject/${sub.id}/export_excel" class="btn btn-sm btn-success">ğŸ“Š å¯¼å‡ºç»Ÿè®¡è¡¨</a>
                                    <a href="#" onclick="exportRegistrationForms(${sub.id})" class="btn btn-sm btn-info">ğŸ“„ å¯¼å‡ºç™»è®°è¡¨</a>
                                </div>
                            </div>
                        `).join('')
                        : `<p class="text-muted">æš‚æ— æ ‡æ®µä¿¡æ¯ã€‚</p>`;

                    return `
                        <div class="project-box">
                            <h5>ğŸ“ é¡¹ç›®ç¼–å·ï¼š${project.code}</h5>
                            <p>åç§°ï¼š${project.name}</p>
                            ${subProjectsHTML}
                        </div>
                    `;
                }).join('');

                count.textContent = `å½“å‰å…±æœ‰ ${data.projects.length} ä¸ªé¡¹ç›®`;
            });
    }

    document.getElementById('filter-deadline').addEventListener('change', applyFilters);
    document.getElementById('filter-leader').addEventListener('input', () => {
        clearTimeout(window.leaderDebounce);
        window.leaderDebounce = setTimeout(applyFilters, 300);
    });

    document.getElementById('clear-filters').addEventListener('click', function (e) {
        e.preventDefault();
        document.getElementById('filter-deadline').value = 'all';
        document.getElementById('filter-leader').value = '';
        applyFilters();
    });
</script>


<script>
    const filterLeaderInput = document.getElementById("filter-leader");
    const suggestionBox = document.getElementById("leader-suggestions");

    filterLeaderInput.addEventListener("input", () => {
        const keyword = filterLeaderInput.value.trim();
        if (!keyword) {
            suggestionBox.style.display = "none";
            return;
        }

        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                suggestionBox.innerHTML = "";
                if (data.length === 0) {
                    const none = document.createElement("div");
                    none.className = "list-group-item text-muted";
                    none.textContent = "æœªæ‰¾åˆ°åŒ¹é…çš„ç»„é•¿";
                    suggestionBox.appendChild(none);
                } else {
                    data.forEach(item => {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "list-group-item list-group-item-action";
                        btn.textContent = item.name + "ï¼ˆ" + item.email + "ï¼‰";
                        btn.onclick = () => {
                            filterLeaderInput.value = item.name;
                            suggestionBox.style.display = "none";
                            applyFilters(); // é€‰ä¸­åç«‹å³è§¦å‘ç­›é€‰
                        };
                        suggestionBox.appendChild(btn);
                    });
                }
                suggestionBox.style.display = "block";
            });
    });

    // ç‚¹å‡»è¾“å…¥æ¡†å¤–æ”¶èµ·å»ºè®®æ¡†
    filterLeaderInput.addEventListener("blur", () => {
        setTimeout(() => {
            suggestionBox.style.display = "none";
        }, 200);
    });
</script>

<script>
    document.getElementById('backupToOssBtn').addEventListener('click', function () {
        if (confirm("ç¡®å®šè¦ç«‹å³å¤‡ä»½å½“å‰æ•°æ®åº“å’Œæ–‡ä»¶åˆ° OSS å—ï¼Ÿ")) {
            fetch('/admin/manual_backup_to_oss', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || "âœ… å¤‡ä»½è¯·æ±‚å·²å‘é€");
                })
                .catch(error => {
                    console.error('å¤‡ä»½å¤±è´¥:', error);
                    alert("âŒ å¤‡ä»½å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—");
                });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const topBar = document.querySelector('.fixed-top-bar');
        const panel = document.querySelector('.panel');

        if (topBar && panel) {
            const topBarHeight = topBar.offsetHeight + 20;  // é¢å¤–ç•™ç™½20px
            panel.style.marginTop = `${topBarHeight}px`;
        }
    });
</script>

<script>
    const memberSearchInput = document.getElementById('member-search');
    const memberSuggestions = document.getElementById('member-suggestions');
    const selectedMembersContainer = document.getElementById('selected-members');
    const memberIdsInput = document.getElementById('member-ids');
    const toggleMemberListBtn = document.getElementById('toggle-member-list');
    const leaderEmailInput = document.getElementById('leader-email');

    let selectedMembers = [];

    // âœ… å°è¯•ä»éšè—åŸŸåŠ è½½åˆå§‹å€¼ï¼ˆå›å¡«ç”¨ï¼‰
    const initialMemberIds = memberIdsInput.value.trim();
    if (initialMemberIds) {
        fetch(`/api/leaders_by_ids?ids=${initialMemberIds}`)
            .then(res => res.json())
            .then(data => {
                selectedMembers = data || [];
                updateSelectedMembersUI();
            });
    }



    let isListVisible = false;

    function updateSelectedMembersUI() {
        selectedMembersContainer.innerHTML = '';
        selectedMembers.forEach(member => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-primary position-relative me-2';
            tag.textContent = member.name + 'ï¼ˆ' + member.email + 'ï¼‰';

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'btn-close btn-close-white position-absolute top-0 end-0';
            closeBtn.style.fontSize = '0.7rem';

            closeBtn.onclick = (e) => {
                e.stopPropagation();
                selectedMembers = selectedMembers.filter(m => m.email !== member.email);
                updateSelectedMembersUI();      // æ›´æ–°æ ‡ç­¾
                updateSuggestionButtonStyles(); // ä»…æ›´æ–°æ ·å¼ï¼Œä¸åˆ·æ–°åˆ—è¡¨
            };

            tag.appendChild(closeBtn);
            selectedMembersContainer.appendChild(tag);
        });

        memberIdsInput.value = selectedMembers.map(m => m.id).join(',');
    }

    function updateSuggestionButtonStyles() {
        const allButtons = memberSuggestions.querySelectorAll('button');
        allButtons.forEach(btn => {
            const email = btn.dataset.email;
            const name = btn.dataset.name;
            const isSelected = selectedMembers.some(m => m.email === email);
            btn.classList.toggle('bg-secondary', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.textContent = `${name}ï¼ˆ${email}ï¼‰${isSelected ? ' âœ” å·²é€‰æ‹©' : ''}`;
        });
    }

    function loadMemberSuggestions(keyword = '') {
        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                memberSuggestions.innerHTML = '';
                data.forEach(item => {
                    if (item.email === leaderEmailInput.value) return;

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'list-group-item list-group-item-action';
                    btn.dataset.id = item.id;
                    btn.dataset.name = item.name;
                    btn.dataset.email = item.email;

                    btn.onclick = () => {
                        const existing = selectedMembers.find(m => m.email === item.email);
                        if (existing) {
                            selectedMembers = selectedMembers.filter(m => m.email !== item.email);
                        } else {
                            selectedMembers.push({id: item.id, name: item.name, email: item.email});
                        }
                        updateSelectedMembersUI();
                        updateSuggestionButtonStyles();
                    };

                    memberSuggestions.appendChild(btn);
                });

                memberSuggestions.style.display = data.length > 0 ? 'block' : 'none';
                isListVisible = true;
                updateSuggestionButtonStyles(); // åˆå§‹åŒ–æ ·å¼
            });
    }

    // æœç´¢ç›‘å¬
    memberSearchInput.addEventListener('input', () => {
        loadMemberSuggestions(memberSearchInput.value.trim());
    });

    // å±•å¼€/æŠ˜å æŒ‰é’®
    toggleMemberListBtn.addEventListener('click', () => {
        if (isListVisible) {
            memberSuggestions.style.display = 'none';
            isListVisible = false;
        } else {
            loadMemberSuggestions('');
        }
    });

    // ç»„é•¿å˜åŠ¨åŒæ­¥
    document.getElementById('leader-name').addEventListener('input', () => {
        loadMemberSuggestions(memberSearchInput.value.trim());
    });
</script>

<script>
    const startInput = document.querySelector('input[name="start_time"]');
    const deadlineInput = document.querySelector('input[name="deadline"]');
    const deadlineHint = document.getElementById('deadline-hint');

    function validateDeadlineInline() {
        const startTime = new Date(startInput.value);
        const deadlineTime = new Date(deadlineInput.value);

        if (deadlineInput.value && startInput.value && deadlineTime <= new Date(startTime.getTime() + 60000)) {
            deadlineHint.textContent = "âŒ æˆªæ­¢æ—¶é—´å¿…é¡»æ™šäºå¼€å§‹æ—¶é—´";
            deadlineHint.classList.remove('d-none');
        } else {
            deadlineHint.textContent = "";
            deadlineHint.classList.add('d-none');
        }
    }

    deadlineInput.addEventListener('input', validateDeadlineInline);
    startInput.addEventListener('input', validateDeadlineInline);
</script>

<script>
    document.querySelector('form').addEventListener('submit', function (e) {
        let valid = true;

        const leaderNameInput = document.getElementById('leader-name');
        const leaderEmailInput = document.getElementById('leader-email');
        const fileUploadInput = document.querySelector('input[name="file_upload"]');

        // æ¸…ç†å·²æœ‰æç¤º
        document.querySelectorAll('.validation-error').forEach(el => el.remove());

        // æ ¡éªŒç»„é•¿å§“å
        if (!leaderNameInput.value.trim()) {
            showError(leaderNameInput, "âŒ è¯·å¡«å†™é¡¹ç›®ç»„é•¿å§“å");
            valid = false;
        }

        // æ ¡éªŒç»„é•¿é‚®ç®±
        if (!leaderEmailInput.value.trim()) {
            showError(leaderNameInput, "âŒ è¯·é€šè¿‡é€‰æ‹©æŒ‰é’®é€‰æ‹©é¡¹ç›®ç»„é•¿ï¼ˆé‚®ç®±ä¸èƒ½ä¸ºç©ºï¼‰");
            valid = false;
        }

        // æ ¡éªŒæ–‡ä»¶ä¸Šä¼ 
        // if (!fileUploadInput.value.trim()) {
        //     showError(fileUploadInput, "âŒ è¯·ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶");
        //     valid = false;
        // }
        if (!fileUploadInput.files || fileUploadInput.files.length === 0) {
            showError(fileUploadInput, "âŒ è¯·ä¸Šä¼ æ‹›æ ‡æ–‡ä»¶");
            valid = false;
        }


        if (!valid) {
            e.preventDefault();  // é˜»æ­¢è¡¨å•æäº¤
        }+

        function showError(element, message) {
            const error = document.createElement('div');
            error.className = 'text-danger small mt-1 validation-error';
            error.textContent = message;
            element.insertAdjacentElement('afterend', error);
        }
    });
</script>

<script>
function validateFileSize(input) {
    const maxSize = 50 * 1024 * 1024;  // 50MB
    const errorDiv = document.getElementById('file-size-error');
    if (input.files.length > 0 && input.files[0].size > maxSize) {
        errorDiv.classList.remove('d-none');
        input.value = "";  // æ¸…ç©ºé€‰æ‹©
    } else {
        errorDiv.classList.add('d-none');
    }
}
</script>
<script>
    if (performance.navigation.type === 1) { // æ˜¯åˆ·æ–°
        const url = new URL(window.location.href);

        // âœ… åªæœ‰å½“æ²¡æœ‰ä»»ä½• flash æ¶ˆæ¯æ—¶æ‰è·³è½¬ clearï¼ˆè¯´æ˜æ˜¯ç”¨æˆ·ä¸»åŠ¨åˆ·æ–°ï¼‰
        const flashExists = document.querySelectorAll('.flash-message').length > 0;
        const hasSessionData = "{{ session.get('project_form_data') is not none }}";

        if (!url.searchParams.has("clear") && !flashExists && hasSessionData === "True") {
            url.searchParams.set("clear", "1");
            window.location.replace(url.toString());
        }
    }
</script>
<script>
function confirmCleanup(type) {
    const message = type === 'uploads'
        ? "âš ï¸ æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰é¡¹ç›®æœ¬åœ°ä¿å­˜çš„æ‹›æ ‡æ–‡ä»¶ï¼Œè¯·ç¡®è®¤å·²å¤‡ä»½è‡³ OSSï¼Œè‹¥è¿˜æ²¡æœ‰ï¼Œè¯·ç‚¹å‡»ä¸Šé¢çš„â€æ‰‹åŠ¨å¤‡ä»½æ•°æ®åˆ°äº‘ç›˜â€œæŒ‰é’®ã€‚å¦åˆ™é‚®ä»¶å°†æ— æ³•å‘é€ï¼æ˜¯å¦ç»§ç»­ï¼Ÿ"
        : "âš ï¸ æ­¤æ“ä½œå°†åˆ é™¤æ‰€æœ‰é¡¹ç›®æœ¬åœ°ä¿å­˜çš„ç™»è®°è¡¨å’Œç»Ÿè®¡è¡¨ï¼Œè¯·ç¡®è®¤å·²å¤‡ä»½è‡³ OSSã€‚è‹¥è¿˜æ²¡æœ‰ï¼Œè¯·ç‚¹å‡»ä¸Šé¢çš„â€æ‰‹åŠ¨å¤‡ä»½æ•°æ®åˆ°äº‘ç›˜â€œæŒ‰é’®ã€‚å¦åˆ™ä¹‹åå°†æ— æ³•å¯¼å‡ºå†å²è®°å½•ï¼æ˜¯å¦ç»§ç»­ï¼Ÿ";

    if (confirm(message)) {
        fetch(`/admin/cleanup_${type}`, {
            method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message || "âœ… æ¸…ç†å®Œæˆ");
            location.reload();  // æ¸…ç†ååˆ·æ–°é¡µé¢ä»¥æ›´æ–°çŠ¶æ€
        })
        .catch(err => {
            console.error(err);
            alert("âŒ æ¸…ç†å¤±è´¥ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—");
        });
    }
}
</script>

<script>
function validateFileSize(input) {
    const maxSize = 50 * 1024 * 1024;  // 50MB
    if (input.files.length > 0 && input.files[0].size > maxSize) {
        showFlashMessage("danger", "âŒ æ–‡ä»¶å¤§å°ä¸èƒ½è¶…è¿‡ 50MB");
        input.value = "";  // æ¸…ç©ºé€‰æ‹©
    }
}

function showFlashMessage(category, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${category} alert-dismissible fade show flash-message flash-once`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.panel').prepend(alertDiv);

    // è‡ªåŠ¨5ç§’æ¶ˆå¤±
    setTimeout(() => {
        bootstrap.Alert.getOrCreateInstance(alertDiv).close();
    }, 5000);
}
</script>

<script>
    document.querySelector('input[name="file_upload"]').addEventListener('change', function () {
        validateFileSize(this);
    });
</script>
<script>
document.querySelectorAll('.projects-list a, .projects-list form').forEach(el => {
    el.addEventListener('click', () => {
        const list = document.querySelector('.projects-list');
        if (list) {
            sessionStorage.setItem('projectListScroll', list.scrollTop);
        }
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const list = document.querySelector('.projects-list');
    const savedScroll = sessionStorage.getItem('projectListScroll');
    if (list && savedScroll !== null) {
        list.scrollTop = parseInt(savedScroll);
        sessionStorage.removeItem('projectListScroll');  // âœ… ä¸€æ¬¡æ€§æ¢å¤
    }
});
</script>

<script>
function changeSortMode() {
    const selected = document.getElementById('sort-mode').value;
    const url = new URL(window.location.href);
    url.searchParams.set('sort', selected);
    url.searchParams.set('page', '1');  // åˆ‡æ¢æ’åºåå›åˆ°ç¬¬ä¸€é¡µ
    window.location.href = url.toString();
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const select = document.getElementById('has-subprojects');
    const isSegmentedField = document.getElementById('is_segmented');
    const subprojectSection = document.getElementById('subproject-section');
    const projectDepositSection = document.getElementById('project-deposit-section');
    const projectFileGroup = document.getElementById('project-file-upload-group');
    const fileUploadInput = document.querySelector('input[name="file_upload"]');
    const projectTimeSection = document.getElementById('project-time-section');
    const form = document.getElementById("add-project-form");
    const wrapper = document.getElementById("subproject-list-wrapper");
    let segmentIndex = 0;

    // âœ… æ ¹æ®ä¸‹æ‹‰é€‰æ‹©æ›´æ–° UI
    function updateUI() {
        const isSegmented = select.value === 'yes';
        isSegmentedField.value = isSegmented ? 'true' : 'false';

        subprojectSection.classList.toggle('d-none', !isSegmented);
        projectDepositSection.classList.toggle('d-none', isSegmented);
        projectFileGroup.classList.toggle('d-none', isSegmented);
        projectTimeSection?.classList.remove('d-none');

        if (fileUploadInput) fileUploadInput.required = !isSegmented;
        projectTimeSection?.querySelectorAll("input").forEach(input => {
            input.required = !isSegmented;
        });
    }

    // âœ… æ·»åŠ æ ‡æ®µè¡Œ
    window.addSubprojectRow = function () {
       const html = `
            <div class="border rounded p-3 mb-3 bg-light subproject-block">
                <div class="mb-2">
                    <label class="form-label">æ ‡æ®µåç§°</label>
                   <input type="text" class="form-control" name="segment_${segmentIndex}_name" placeholder="æ ‡æ®µåç§°ï¼ˆå¯ç•™ç©ºï¼‰">
                </div>
                <div class="mb-2">
                    <label class="form-label">ä¿è¯é‡‘é‡‘é¢ï¼ˆå…ƒï¼‰</label>
                    <input type="number" step="0.01" class="form-control" name="segment_${segmentIndex}_deposit_amount" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">ä¸Šä¼ æ–‡ä»¶</label>
                    <input type="file" class="form-control" name="segment_${segmentIndex}_file_upload" accept=".pdf,.doc,.docx,.zip,.rar" required>
                </div>
            </div>`;
        wrapper.insertAdjacentHTML('beforeend', html);
        segmentIndex++;
        document.getElementById('segment_count').value = segmentIndex;
    };

    // âœ… æäº¤å‰éªŒè¯è‡³å°‘æœ‰ä¸€ä¸ªæ ‡æ®µ
    form.addEventListener("submit", function (e) {
        if (isSegmentedField.value === "true") {
            const blocks = wrapper.querySelectorAll('.subproject-block');
            if (blocks.length === 0) {
                e.preventDefault();
                alert("âš ï¸ è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªæ ‡æ®µï¼Œæˆ–é€‰æ‹©â€œä¸åŒ…å«æ ‡æ®µâ€ä»¥æ”¹ä¸ºé¡¹ç›®çº§æ–¹å¼");
            }
        }
    });

    // åˆå§‹åŒ– UI
    updateUI();
    select.addEventListener('change', updateUI);
});
</script>



</body>
</html>


