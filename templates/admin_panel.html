<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{{ url_for('static', filename='bid.png') }}" type="image/png">
    <title>后台管理面板 - 云南国合招标系统</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        body {
            /*background: url("../static/img/admin_panel.jpg") no-repeat center center fixed;*/
            background-size: cover;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .panel {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 15px 20px;
            border-radius: 12px;
            max-width: 1100px;
            margin: 5vh auto;
            box-shadow: 0 0 16px rgba(0, 0, 0, 0.2);
            position: relative;

            /* 新增：限制最大高度 + 滚动条 */
            max-height: 90vh;
            overflow-y: auto;
        }


        .project-box {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .admin-logout-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .projects-list {
            max-height: 850px;
            overflow-y: auto;
        }

        .search-box {
            width: 100%;
            max-width: 250px;
            margin-left: auto;
        }


    </style>
    <style>
        @keyframes flash-once {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 1;
            }
        }

        .flash-once {
            animation: flash-once 1s ease-in-out;
        }
    </style>
    <style>
.fixed-top-bar {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    z-index: 1000;
    padding: 10px 20px;
    background-color: white;
    border-bottom: 1px solid #ccc;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}

/* 控制弹出菜单不占据主栏宽度，仅作为右浮层弹出 */
.more-dropdown-menu {
    min-width: 250px;
    margin-top: 10px;
    border-radius: 12px;
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
}

.more-dropdown-menu .dropdown-item {
    display: flex;
    align-items: center;
    gap: 6px;
    padding: 10px 16px;
}


        .fixed-top-bar .btn {
            min-width: 200px;
        }

        /* 响应式：小屏幕改为竖排布局 */
        @media (max-width: 768px) {
            .fixed-top-bar {
                flex-direction: column;
                align-items: stretch;
            }

            .panel {
                margin-top: 160px !important; /* 保证 panel 不被按钮栏遮挡 */
            }
        }

        /* 原始 margin-top 调整以避开 fixed 顶栏 */
        .panel {
            margin-top: 100px; /* 留出顶部按钮栏空间 */
            margin-bottom: 5vh;
        }
    </style>
</head>
<body>

<div class="fixed-top-bar bg-light p-2 border-bottom d-flex justify-content-between align-items-center">
    <!-- 左侧“更多功能”下拉 -->
    <div class="dropdown">
        <button class="btn btn-outline-secondary dropdown-toggle" type="button" id="moreDropdown" data-bs-toggle="dropdown" aria-expanded="false">
            📦 更多功能
        </button>
        <ul class="dropdown-menu dropdown-menu-start more-dropdown-menu" aria-labelledby="moreDropdown">
            <li><a class="dropdown-item" href="{{ url_for('view_mail_logs') }}">📬 查看定时汇报邮件记录</a></li>
            <li><a class="dropdown-item" href="{{ url_for('manage_leaders') }}">👥 管理项目组长</a></li>
            <li><button class="dropdown-item" id="backupToOssBtn">🗄️ 手动备份数据到云盘</button></li>
                <!-- ✅ 新增导出按钮 -->
            <li>
                <a class="dropdown-item text-success" href="{{ url_for('export_project_summary') }}">
                    📊 导出项目统计总表
                </a>
            </li>
            <li><button class="dropdown-item text-danger" onclick="confirmCleanup('uploads')">🧹 清除本地项目文件</button></li>
            <li><button class="dropdown-item text-danger" onclick="confirmCleanup('downloads')">🧹 清除本地登记表和统计表</button></li>
        </ul>
    </div>

    <!-- 右侧退出 -->
    <a href="{{ url_for('logout') }}" class="btn btn-outline-secondary">退出登录</a>
</div>



<div class="panel">
    <!-- ✅ 插入这里：显示 flash 消息 -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-{{ category }} alert-dismissible fade show flash-message flash-once" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endfor %}
    {% endif %}
    {% endwith %}


    <div class="row align-items-center mb-3">
        <div class="col-md-6">
            <h3 class="mb-0">📊 项目与投标客户管理</h3>
        </div>
        <div class="col-md-6 text-end">
            <input type="text" id="search-project" class="form-control d-inline-block w-auto"
                   placeholder="搜索项目名称或编号..." style="max-width: 250px;">
        </div>
    </div>


    <!-- ✅ 新增：按截止状态 + 组长姓名筛选（可组合） -->
    <div class="row mb-3 px-3 align-items-end">
        <div class="col-md-4">
            <label for="filter-deadline" class="form-label">按时间状态筛选</label>
            <select class="form-select" id="filter-deadline">
                <option value="all">全部项目</option>
                <option value="not_started">未开始</option>
                <option value="in_progress">进行中</option>
                <option value="ended">已截止</option>
            </select>
        </div>
        <div class="col-md-4">
            <label for="filter-leader" class="form-label">按项目组长筛选</label>
            <div class="position-relative">
                <input type="text" class="form-control" id="filter-leader" placeholder="输入组长姓名...">
                <div id="leader-suggestions" class="list-group position-absolute w-100"
                     style="z-index: 10; max-height: 240px; overflow-y: auto; display: none;"></div>
            </div>

        </div>
        <div class="col-md-2">
            <button class="btn btn-secondary mt-3 w-100" id="clear-filters">清除筛选</button>
        </div>
    </div>

    <!-- 内容左右分栏 -->
    <div class="row">
        <!-- 左栏：添加新项目 -->
        <div class="col-md-4 mb-3">
            <h4 class="mb-3">📤 添加新项目</h4>

            <form id="add-project-form" method="POST" action="{{ url_for('add_project') }}" enctype="multipart/form-data" class="row g-3">
                <input type="hidden" name="redirect_url" value="{{ request.path }}">
                <input type="hidden" id="is_segmented" name="is_segmented" value="false">
                <input type="hidden" id="segment-count" name="segment_count" value="0">

                <div class="col-12">
                    <label class="form-label">项目名称</label>
                    <input type="text" class="form-control" name="name"
                           value="{{ session.get('project_form_data', {}).get('name', '') }}" required>
                </div>
                <div class="col-12">
                    <label class="form-label">项目编号</label>
                    <input type="text" class="form-control" name="code"
                           value="{{ session.get('project_form_data', {}).get('code', '') }}" required>
                </div>

                <div class="col-12">
                    <label class="form-label">采购人</label>
                    <input type="text" class="form-control" name="purchaser"
                           value="{{ session.get('project_form_data', {}).get('purchaser', '') }}" required>
                </div>

                <div class="col-12">
                    <label class="form-label">采购金额（元）</label>
                    <input type="number" step="0.01" class="form-control" name="budget_amount"
                           value="{{ session.get('project_form_data', {}).get('budget_amount', '0.00') }}" required>
                </div>


                <div class="col-12">
                    <label class="form-label">是否包含下辖标段</label>
                    <select class="form-select" id="has-subprojects" name="has_subprojects">
                        <option value="no" selected>否</option>
                        <option value="yes">是</option>
                    </select>
                </div>

                <!-- ✅ 项目级时间字段，仅在无标段时显示 -->
                <div class="col-12" id="project-time-section">
                    <div class="mb-2">
                        <label class="form-label">文件获取开始时间</label>
                        <input type="datetime-local" class="form-control" name="start_time"
                               value="{{ session.get('project_form_data', {}).get('start_time', '') }}">
                    </div>
                    <div class="mb-2">
                        <label class="form-label">文件获取截止时间</label>
                        <input type="datetime-local" class="form-control" name="deadline"
                               value="{{ session.get('project_form_data', {}).get('deadline', '') }}">
                    </div>
                    <div id="deadline-hint" class="text-danger small mt-1 d-none"></div>
                </div>

                <!-- ✅ 项目保证金 -->
                <div class="col-12" id="project-deposit-section">
                    <label class="form-label">保证金金额（元）</label>
                    <input type="number" step="0.01" class="form-control" name="deposit_amount"
                           value="{{ session.get('project_form_data', {}).get('deposit_amount', '0.00') }}">
                </div>



                <div class="col-12">
                    <label class="form-label">项目组长姓名（必填）</label>
                    <div class="input-group">
                        <input type="text" class="form-control" id="leader-name" name="leader_name"
                               placeholder="输入姓名进行模糊匹配"
                               value="{{ session.get('project_form_data', {}).get('leader_name', '') }}" required>
                        <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse"
                                data-bs-target="#leader-list">📂 选择
                        </button>
                    </div>
                    <div class="collapse mt-1" id="leader-list">
                        <div class="list-group" id="leader-options" style="max-height: 240px; overflow-y: auto;"></div>
                    </div>
                    <input type="hidden" name="leader_email" id="leader-email"
                           value="{{ session.get('project_form_data', {}).get('leader_email', '') }}">
                </div>

                <div class="col-12">
                    <label class="form-label">选择项目组成员（非必填）（可多选）</label>
                    <div class="input-group">
                        <input type="text" id="member-search" class="form-control"
                               placeholder="输入姓名进行模糊搜索">
                        <button class="btn btn-outline-secondary" type="button" id="toggle-member-list">📂 选择</button>
                    </div>
                    <div id="member-suggestions" class="list-group mt-1"
                         style="z-index: 10; display: none; max-height: 200px; overflow-y: auto;"></div>
                    <div id="selected-members" class="mt-2 d-flex flex-wrap gap-2"></div>
                    <input type="hidden" name="member_ids" id="member-ids"
                           value="{{ session.get('project_form_data', {}).get('member_ids', '') }}">
                </div>

                <!-- 添加在此处 -->
                <div id="subproject-section" class="col-12 mt-3">
                    <div class="d-flex justify-content-between align-items-center">
                        <label class="form-label">📦 添加标段</label>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="addSubprojectRow()">➕ 添加标段</button>
                    </div>
                    <div id="subproject-list-wrapper" class="mt-3"></div>
                </div>

                <!-- 隐藏域必须也在 form 中 -->
                <input type="hidden" name="segment_count" id="segment_count" value="0">



               <!-- ✅ 项目级文件上传区域（仅当不包含标段时显示） -->
                <div class="col-12" id="project-file-upload-group">
                    <label class="form-label">招标文件（最大50MB，仅支持PDF/Word/zip/rar）</label>
                    <input type="file" class="form-control" name="file_upload" accept=".pdf,.doc,.docx,.zip,.rar" required>
                    <div id="file-size-error" class="text-danger small mt-1 d-none">❌ 文件大小不能超过 50MB</div>
                </div>


                <div class="col-12 text-end">
                    <button type="submit" class="btn btn-success w-100">➕ 添加项目</button>
                </div>
            </form>
        </div>

        <!-- 右栏：项目列表 -->
        <div class="col-md-8 position-relative" style="min-height: 600px;">

           <!-- 标题行：只显示“项目列表” -->
            <div class="d-flex justify-content-between align-items-center mb-1">
                <h4 class="mb-0">👨‍💻 项目列表</h4>
            </div>

            <!-- 第二行：左侧显示数量，右侧排序选择 -->
            <div class="d-flex justify-content-between align-items-center mb-3">
                <div id="project-count" class="text-muted">当前共有 {{ total_count }} 个项目</div>
                <div>
                    <label for="sort-mode" class="form-label mb-0 me-2">排序方式</label>
                    <select id="sort-mode" class="form-select form-select-sm d-inline-block w-auto" onchange="changeSortMode()">
                        <option value="code_asc" {% if sort_mode == 'code_asc' %}selected{% endif %}>项目编号升序</option>
                        <option value="code_desc" {% if sort_mode == 'code_desc' %}selected{% endif %}>项目编号降序</option>
                        <option value="created_desc" {% if sort_mode == 'created_desc' %}selected{% endif %}>添加顺序</option>
                    </select>
                </div>
            </div>

            <div class="projects-list mb-5 pb-5">
                {% for project in projects %}
                    <div class="project-box">
                        <h5>📁 项目编号：{{ project.code }}</h5>
                       <p class="mb-1">
                            <strong>名称：</strong>{{ project.name }} &nbsp;&nbsp;
                            <strong>项目编号：</strong>{{ project.code }}
                        </p>
                        <p class="mb-1">
                            <strong>采购人：</strong>{{ project.purchaser }} &nbsp;&nbsp;
                            <strong>采购金额：</strong>¥ {{ project.budget_amount }} 元
                        </p>
                        <p class="mb-1">
                            <strong>开始时间：</strong>{{ project.start_time.strftime('%Y-%m-%d %H:%M') }} &nbsp;&nbsp;
                            <strong>截止时间：</strong>{{ project.deadline.strftime('%Y-%m-%d %H:%M') }}
                        </p>
                        <p class="mb-1">
                            <strong>项目组长：</strong>{{ project.leader_email}} &nbsp;&nbsp;
                            <strong>项目组员：</strong>{{ project.members }}
                        </p>
                        {% if project.sub_projects %}
                            {% for sub in project.sub_projects %}
                            <div class="border-start ps-3 mb-2">
                                <p>
                                    <strong>📌 标段：</strong>{{ sub.name }}<br>
                                    文件获取时间：{{ sub.start_time.strftime('%Y年%m月%d日%H时%M分') }} ~ {{ sub.deadline.strftime('%Y年%m月%d日%H时%M分') }}<br>
                                    保证金：¥ {{ sub.deposit_amount }} 元<br>
                                    上传文件：{{ sub.file_path or "暂无" }}
                                </p>
                                <div class="mb-2">
                                    <a href="{{ url_for('view_bids', project_id=sub.project_id) }}" class="btn btn-sm btn-primary">📂 查看客户登记</a>
                                    <a href="{{ url_for('edit_project', project_id=sub.id) }}" class="btn btn-sm btn-warning">✏️ 编辑标段</a>
                                    <form action="{{ url_for('delete_sub_project', sub_project_id=sub.id) }}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除此标段？')">🗑️ 删除</button>
                                    </form>
                                    <!-- ✅ 标段下按钮 -->
                                    <a href="#" id="export-btn-project-{{ project.id }}-sub-{{ sub.id }}"
                                       onclick="exportRegistrationForms({{ project.id }}, 'project-{{ project.id }}-sub-{{ sub.id }}')"
                                       class="btn btn-sm btn-info">📄 导出登记表（压缩包）</a>

                                   <a href="{{ url_for('export_excel', sub_project_id=sub.id) }}" class="btn btn-sm btn-success">📊 导出统计表</a>
                                </div>
                            </div>
                            {% endfor %}
                        {% else %}
                            <p class="text-muted">暂无标段信息。</p>
                            <div class="mb-2">
                                <a href="{{ url_for('view_bids', project_id=project.id) }}" class="btn btn-sm btn-primary">📂 查看客户登记</a>
                                <a href="{{ url_for('edit_project', project_id=project.id) }}" class="btn btn-sm btn-warning">✏️ 编辑项目</a>
                                <form action="{{ url_for('delete_project', project_id=project.id) }}" method="POST" style="display:inline;">
                                    <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除整个项目？')">🗑️ 删除项目</button>
                                </form>
                                <!-- ✅ 无标段项目按钮 -->
                                <a href="#" id="export-btn-project-{{ project.id }}"
                                   onclick="exportRegistrationForms({{ project.id }}, 'project-{{ project.id }}')"
                                   class="btn btn-sm btn-info">📄 导出登记表（压缩包）</a>
                                <a href="{{ url_for('export_excel_project', project_id=project.id) }}" class="btn btn-sm btn-success">📊 导出统计表</a>
                            </div>
                        {% endif %}

                    </div>
                    {% endfor %}

            </div>
           <!-- ✅ 固定在 .col-md-8 内底部 -->
            <nav class="position-absolute bottom-0 start-0 w-100 py-3 bg-white border-top">
              <ul class="pagination justify-content-center mb-0">
                {% for p in range(1, (total_count // per_page) + (1 if total_count % per_page else 0) + 1) %}
                  <li class="page-item {% if p == page %}active{% endif %}">
                    <a class="page-link" href="{{ url_for('admin_panel', sort_mode=sort_mode, page=p) }}">{{ p }}</a>
                  </li>
                {% endfor %}
              </ul>
            </nav>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.getElementById('search-project').addEventListener('input', function (e) {
        const searchQuery = e.target.value.trim();
        const list = document.querySelector('.projects-list');
        const count = document.getElementById("project-count");

        if (searchQuery === "") {
            window.location.reload();
        } else {
            fetch(`/search_projects?query=${searchQuery}`)
                .then(response => response.json())
                .then(data => {
                    if (data.projects.length > 0) {
                        const results = data.projects.map(project => {
                            const subProjectsHTML = project.sub_projects && project.sub_projects.length > 0
                                ? project.sub_projects.map(sub => `
                                    <div class="border-start ps-3 mb-2">
                                        <p>
                                            <strong>📌 标段：</strong>${sub.name}<br>
                                            文件获取时间：${sub.start_time} ~ ${sub.deadline}<br>
                                            保证金：¥ ${sub.deposit_amount} 元<br>
                                            上传文件：${sub.file_path || "暂无"}
                                        </p>
                                        <div class="mb-2">
                                            <a href="/admin/project/${project.id}/bids/${sub.id}" class="btn btn-sm btn-primary">📂 查看客户登记</a>
                                            <a href="/admin/edit_sub_project/${sub.id}" class="btn btn-sm btn-warning">✏️ 编辑标段</a>
                                            <form action="/admin/delete_sub_project/${sub.id}" method="POST" style="display:inline;">
                                                <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除此标段？')">🗑️ 删除</button>
                                            </form>
                                            <a href="/admin/subproject/${sub.id}/export_excel" class="btn btn-sm btn-success">📊 导出统计表</a>
                                            <a href="#" onclick="exportRegistrationForms(${sub.id})" class="btn btn-sm btn-info">📄 导出登记表</a>
                                        </div>
                                    </div>
                                `).join('')
                                : `<p class="text-muted">暂无标段信息。</p>`;

                            return `
                                <div class="project-box">
                                    <h5>📁 项目编号：${project.code}</h5>
                                    <p>名称：${project.name}</p>
                                    ${subProjectsHTML}
                                </div>
                            `;
                        }).join('');

                        list.innerHTML = results;
                        count.textContent = `当前共有 ${data.projects.length} 个项目`;
                    } else {
                        list.innerHTML = `<p class="text-muted">🔍 未找到匹配的项目记录。</p>`;
                        count.textContent = `当前共有 0 个项目`;
                    }
                });
        }
    });
</script>

<script>
    // 让 flash 消息在页面加载后 5 秒自动淡出
    window.addEventListener('DOMContentLoaded', function () {
        setTimeout(function () {
            const flashMessages = document.querySelectorAll('.flash-message');
            flashMessages.forEach(function (msg) {
                // 使用 Bootstrap 自带的方法让它消失
                let alert = bootstrap.Alert.getOrCreateInstance(msg);
                alert.close();
            });
        }, 5000); // 5000毫秒 = 5秒
    });
</script>

<script>
    function exportRegistrationForms(projectId, btnKey) {
        const exportBtn = document.getElementById(`export-btn-${btnKey}`);
        if (!exportBtn) return;

        exportBtn.disabled = true;
        const originalText = exportBtn.innerHTML;
        exportBtn.innerHTML = '⏳ 正在打包，请稍候...';

        // ✅ 统一调用后端路由（项目级别）
        window.location.href = `/export_registration_forms_project/${projectId}`;

        setTimeout(() => {
            exportBtn.disabled = false;
            exportBtn.innerHTML = originalText;
        }, 2000);
    }
</script>


<script>
    const leaderInput = document.getElementById("leader-name");
    const emailHidden = document.getElementById("leader-email");
    const listBox = document.getElementById("leader-options");
    const collapseBox = document.getElementById("leader-list");
    const collapseBtn = document.querySelector("[data-bs-target='#leader-list']");

    let debounceTimer = null;

    function loadLeaders(keyword = "") {
        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                listBox.innerHTML = "";

                if (data.length === 0) {
                    const none = document.createElement("div");
                    none.className = "list-group-item text-muted";
                    none.textContent = "未找到匹配的项目组长";
                    listBox.appendChild(none);
                    return;
                }

                data.forEach(item => {
                    const isAlreadySelectedMember = selectedMembers.some(m => m.email === item.email);
                    if (isAlreadySelectedMember) return;  // ✅ 如果这个人已经是成员了，就不显示为组长候选

                    const btn = document.createElement("button");
                    btn.className = "list-group-item list-group-item-action";
                    btn.type = "button";
                    btn.textContent = item.name + "（" + item.email + "）";
                    btn.onclick = () => {
                        leaderInput.value = item.name;
                        emailHidden.value = item.email;

                        // 👇 更新成员列表，排除新组长
                        loadMemberSuggestions(memberSearchInput.value.trim());

                        bootstrap.Collapse.getInstance(collapseBox)?.hide();
                    };
                    listBox.appendChild(btn);
                });

            });
    }

    // 监听输入框输入
    leaderInput.addEventListener("input", () => {
        const keyword = leaderInput.value.trim();
        clearTimeout(debounceTimer);
        debounceTimer = setTimeout(() => {
            if (keyword) {
                loadLeaders(keyword);
                bootstrap.Collapse.getOrCreateInstance(collapseBox).show();
            } else {
                bootstrap.Collapse.getOrCreateInstance(collapseBox).hide();
            }
        }, 200);
    });

    // 📂按钮点击：始终加载全部组长 + 展开
    collapseBtn.addEventListener("click", () => {
        loadLeaders("");  // 👉 加载所有
        bootstrap.Collapse.getOrCreateInstance(collapseBox).toggle();
    });

    // 初始化时不加载（根据你要求）
</script>


<script>
    function applyFilters() {
        const deadlineVal = document.getElementById('filter-deadline').value;
        const leaderVal = document.getElementById('filter-leader').value.trim();
        const params = new URLSearchParams();
        const list = document.querySelector('.projects-list');
        const count = document.getElementById("project-count");

        if (deadlineVal !== 'all') {
            params.append('deadline', deadlineVal);
        }
        if (leaderVal) {
            params.append('leader', leaderVal);
        }

        fetch(`/filter_projects?${params.toString()}`)
            .then(response => response.json())
            .then(data => {
                if (data.projects.length === 0) {
                    list.innerHTML = '<p class="text-muted">🔍 未找到匹配的项目记录。</p>';
                    count.textContent = `当前共有 0 个项目`;
                    return;
                }

                list.innerHTML = data.projects.map(project => {
                    const subProjectsHTML = project.sub_projects && project.sub_projects.length > 0
                        ? project.sub_projects.map(sub => `
                            <div class="border-start ps-3 mb-2">
                                <p>
                                    <strong>📌 标段：</strong>${sub.name}<br>
                                    文件获取时间：${sub.start_time} ~ ${sub.deadline}<br>
                                    保证金：¥ ${sub.deposit_amount} 元<br>
                                    上传文件：${sub.file_path || "暂无"}
                                </p>
                                <div class="mb-2">
                                    <a href="/admin/project/${project.id}/bids/${sub.id}" class="btn btn-sm btn-primary">📂 查看客户登记</a>
                                    <a href="/admin/edit_sub_project/${sub.id}" class="btn btn-sm btn-warning">✏️ 编辑标段</a>
                                    <form action="/admin/delete_sub_project/${sub.id}" method="POST" style="display:inline;">
                                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('确定删除此标段？')">🗑️ 删除</button>
                                    </form>
                                    <a href="/admin/subproject/${sub.id}/export_excel" class="btn btn-sm btn-success">📊 导出统计表</a>
                                    <a href="#" onclick="exportRegistrationForms(${sub.id})" class="btn btn-sm btn-info">📄 导出登记表</a>
                                </div>
                            </div>
                        `).join('')
                        : `<p class="text-muted">暂无标段信息。</p>`;

                    return `
                        <div class="project-box">
                            <h5>📁 项目编号：${project.code}</h5>
                            <p>名称：${project.name}</p>
                            ${subProjectsHTML}
                        </div>
                    `;
                }).join('');

                count.textContent = `当前共有 ${data.projects.length} 个项目`;
            });
    }

    document.getElementById('filter-deadline').addEventListener('change', applyFilters);
    document.getElementById('filter-leader').addEventListener('input', () => {
        clearTimeout(window.leaderDebounce);
        window.leaderDebounce = setTimeout(applyFilters, 300);
    });

    document.getElementById('clear-filters').addEventListener('click', function (e) {
        e.preventDefault();
        document.getElementById('filter-deadline').value = 'all';
        document.getElementById('filter-leader').value = '';
        applyFilters();
    });
</script>


<script>
    const filterLeaderInput = document.getElementById("filter-leader");
    const suggestionBox = document.getElementById("leader-suggestions");

    filterLeaderInput.addEventListener("input", () => {
        const keyword = filterLeaderInput.value.trim();
        if (!keyword) {
            suggestionBox.style.display = "none";
            return;
        }

        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                suggestionBox.innerHTML = "";
                if (data.length === 0) {
                    const none = document.createElement("div");
                    none.className = "list-group-item text-muted";
                    none.textContent = "未找到匹配的组长";
                    suggestionBox.appendChild(none);
                } else {
                    data.forEach(item => {
                        const btn = document.createElement("button");
                        btn.type = "button";
                        btn.className = "list-group-item list-group-item-action";
                        btn.textContent = item.name + "（" + item.email + "）";
                        btn.onclick = () => {
                            filterLeaderInput.value = item.name;
                            suggestionBox.style.display = "none";
                            applyFilters(); // 选中后立即触发筛选
                        };
                        suggestionBox.appendChild(btn);
                    });
                }
                suggestionBox.style.display = "block";
            });
    });

    // 点击输入框外收起建议框
    filterLeaderInput.addEventListener("blur", () => {
        setTimeout(() => {
            suggestionBox.style.display = "none";
        }, 200);
    });
</script>

<script>
    document.getElementById('backupToOssBtn').addEventListener('click', function () {
        if (confirm("确定要立即备份当前数据库和文件到 OSS 吗？")) {
            fetch('/admin/manual_backup_to_oss', {
                method: 'POST'
            })
                .then(response => response.json())
                .then(data => {
                    alert(data.message || "✅ 备份请求已发送");
                })
                .catch(error => {
                    console.error('备份失败:', error);
                    alert("❌ 备份失败，请查看控制台日志");
                });
        }
    });
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const topBar = document.querySelector('.fixed-top-bar');
        const panel = document.querySelector('.panel');

        if (topBar && panel) {
            const topBarHeight = topBar.offsetHeight + 20;  // 额外留白20px
            panel.style.marginTop = `${topBarHeight}px`;
        }
    });
</script>

<script>
    const memberSearchInput = document.getElementById('member-search');
    const memberSuggestions = document.getElementById('member-suggestions');
    const selectedMembersContainer = document.getElementById('selected-members');
    const memberIdsInput = document.getElementById('member-ids');
    const toggleMemberListBtn = document.getElementById('toggle-member-list');
    const leaderEmailInput = document.getElementById('leader-email');

    let selectedMembers = [];

    // ✅ 尝试从隐藏域加载初始值（回填用）
    const initialMemberIds = memberIdsInput.value.trim();
    if (initialMemberIds) {
        fetch(`/api/leaders_by_ids?ids=${initialMemberIds}`)
            .then(res => res.json())
            .then(data => {
                selectedMembers = data || [];
                updateSelectedMembersUI();
            });
    }



    let isListVisible = false;

    function updateSelectedMembersUI() {
        selectedMembersContainer.innerHTML = '';
        selectedMembers.forEach(member => {
            const tag = document.createElement('span');
            tag.className = 'badge bg-primary position-relative me-2';
            tag.textContent = member.name + '（' + member.email + '）';

            const closeBtn = document.createElement('button');
            closeBtn.type = 'button';
            closeBtn.className = 'btn-close btn-close-white position-absolute top-0 end-0';
            closeBtn.style.fontSize = '0.7rem';

            closeBtn.onclick = (e) => {
                e.stopPropagation();
                selectedMembers = selectedMembers.filter(m => m.email !== member.email);
                updateSelectedMembersUI();      // 更新标签
                updateSuggestionButtonStyles(); // 仅更新样式，不刷新列表
            };

            tag.appendChild(closeBtn);
            selectedMembersContainer.appendChild(tag);
        });

        memberIdsInput.value = selectedMembers.map(m => m.id).join(',');
    }

    function updateSuggestionButtonStyles() {
        const allButtons = memberSuggestions.querySelectorAll('button');
        allButtons.forEach(btn => {
            const email = btn.dataset.email;
            const name = btn.dataset.name;
            const isSelected = selectedMembers.some(m => m.email === email);
            btn.classList.toggle('bg-secondary', isSelected);
            btn.classList.toggle('text-white', isSelected);
            btn.textContent = `${name}（${email}）${isSelected ? ' ✔ 已选择' : ''}`;
        });
    }

    function loadMemberSuggestions(keyword = '') {
        fetch("/api/leaders?q=" + encodeURIComponent(keyword))
            .then(res => res.json())
            .then(data => {
                memberSuggestions.innerHTML = '';
                data.forEach(item => {
                    if (item.email === leaderEmailInput.value) return;

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'list-group-item list-group-item-action';
                    btn.dataset.id = item.id;
                    btn.dataset.name = item.name;
                    btn.dataset.email = item.email;

                    btn.onclick = () => {
                        const existing = selectedMembers.find(m => m.email === item.email);
                        if (existing) {
                            selectedMembers = selectedMembers.filter(m => m.email !== item.email);
                        } else {
                            selectedMembers.push({id: item.id, name: item.name, email: item.email});
                        }
                        updateSelectedMembersUI();
                        updateSuggestionButtonStyles();
                    };

                    memberSuggestions.appendChild(btn);
                });

                memberSuggestions.style.display = data.length > 0 ? 'block' : 'none';
                isListVisible = true;
                updateSuggestionButtonStyles(); // 初始化样式
            });
    }

    // 搜索监听
    memberSearchInput.addEventListener('input', () => {
        loadMemberSuggestions(memberSearchInput.value.trim());
    });

    // 展开/折叠按钮
    toggleMemberListBtn.addEventListener('click', () => {
        if (isListVisible) {
            memberSuggestions.style.display = 'none';
            isListVisible = false;
        } else {
            loadMemberSuggestions('');
        }
    });

    // 组长变动同步
    document.getElementById('leader-name').addEventListener('input', () => {
        loadMemberSuggestions(memberSearchInput.value.trim());
    });
</script>

<script>
    const startInput = document.querySelector('input[name="start_time"]');
    const deadlineInput = document.querySelector('input[name="deadline"]');
    const deadlineHint = document.getElementById('deadline-hint');

    function validateDeadlineInline() {
        const startTime = new Date(startInput.value);
        const deadlineTime = new Date(deadlineInput.value);

        if (deadlineInput.value && startInput.value && deadlineTime <= new Date(startTime.getTime() + 60000)) {
            deadlineHint.textContent = "❌ 截止时间必须晚于开始时间";
            deadlineHint.classList.remove('d-none');
        } else {
            deadlineHint.textContent = "";
            deadlineHint.classList.add('d-none');
        }
    }

    deadlineInput.addEventListener('input', validateDeadlineInline);
    startInput.addEventListener('input', validateDeadlineInline);
</script>

<script>
    document.querySelector('form').addEventListener('submit', function (e) {
        let valid = true;

        const leaderNameInput = document.getElementById('leader-name');
        const leaderEmailInput = document.getElementById('leader-email');
        const fileUploadInput = document.querySelector('input[name="file_upload"]');

        // 清理已有提示
        document.querySelectorAll('.validation-error').forEach(el => el.remove());

        // 校验组长姓名
        if (!leaderNameInput.value.trim()) {
            showError(leaderNameInput, "❌ 请填写项目组长姓名");
            valid = false;
        }

        // 校验组长邮箱
        if (!leaderEmailInput.value.trim()) {
            showError(leaderNameInput, "❌ 请通过选择按钮选择项目组长（邮箱不能为空）");
            valid = false;
        }

        // 校验文件上传
        // if (!fileUploadInput.value.trim()) {
        //     showError(fileUploadInput, "❌ 请上传招标文件");
        //     valid = false;
        // }
        if (!fileUploadInput.files || fileUploadInput.files.length === 0) {
            showError(fileUploadInput, "❌ 请上传招标文件");
            valid = false;
        }


        if (!valid) {
            e.preventDefault();  // 阻止表单提交
        }+

        function showError(element, message) {
            const error = document.createElement('div');
            error.className = 'text-danger small mt-1 validation-error';
            error.textContent = message;
            element.insertAdjacentElement('afterend', error);
        }
    });
</script>

<script>
function validateFileSize(input) {
    const maxSize = 50 * 1024 * 1024;  // 50MB
    const errorDiv = document.getElementById('file-size-error');
    if (input.files.length > 0 && input.files[0].size > maxSize) {
        errorDiv.classList.remove('d-none');
        input.value = "";  // 清空选择
    } else {
        errorDiv.classList.add('d-none');
    }
}
</script>
<script>
    if (performance.navigation.type === 1) { // 是刷新
        const url = new URL(window.location.href);

        // ✅ 只有当没有任何 flash 消息时才跳转 clear（说明是用户主动刷新）
        const flashExists = document.querySelectorAll('.flash-message').length > 0;
        const hasSessionData = "{{ session.get('project_form_data') is not none }}";

        if (!url.searchParams.has("clear") && !flashExists && hasSessionData === "True") {
            url.searchParams.set("clear", "1");
            window.location.replace(url.toString());
        }
    }
</script>
<script>
function confirmCleanup(type) {
    const message = type === 'uploads'
        ? "⚠️ 此操作将删除所有项目本地保存的招标文件，请确认已备份至 OSS，若还没有，请点击上面的”手动备份数据到云盘“按钮。否则邮件将无法发送！是否继续？"
        : "⚠️ 此操作将删除所有项目本地保存的登记表和统计表，请确认已备份至 OSS。若还没有，请点击上面的”手动备份数据到云盘“按钮。否则之后将无法导出历史记录！是否继续？";

    if (confirm(message)) {
        fetch(`/admin/cleanup_${type}`, {
            method: 'POST'
        })
        .then(res => res.json())
        .then(data => {
            alert(data.message || "✅ 清理完成");
            location.reload();  // 清理后刷新页面以更新状态
        })
        .catch(err => {
            console.error(err);
            alert("❌ 清理失败，请查看控制台日志");
        });
    }
}
</script>

<script>
function validateFileSize(input) {
    const maxSize = 50 * 1024 * 1024;  // 50MB
    if (input.files.length > 0 && input.files[0].size > maxSize) {
        showFlashMessage("danger", "❌ 文件大小不能超过 50MB");
        input.value = "";  // 清空选择
    }
}

function showFlashMessage(category, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${category} alert-dismissible fade show flash-message flash-once`;
    alertDiv.role = 'alert';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    `;
    document.querySelector('.panel').prepend(alertDiv);

    // 自动5秒消失
    setTimeout(() => {
        bootstrap.Alert.getOrCreateInstance(alertDiv).close();
    }, 5000);
}
</script>

<script>
    document.querySelector('input[name="file_upload"]').addEventListener('change', function () {
        validateFileSize(this);
    });
</script>
<script>
document.querySelectorAll('.projects-list a, .projects-list form').forEach(el => {
    el.addEventListener('click', () => {
        const list = document.querySelector('.projects-list');
        if (list) {
            sessionStorage.setItem('projectListScroll', list.scrollTop);
        }
    });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const list = document.querySelector('.projects-list');
    const savedScroll = sessionStorage.getItem('projectListScroll');
    if (list && savedScroll !== null) {
        list.scrollTop = parseInt(savedScroll);
        sessionStorage.removeItem('projectListScroll');  // ✅ 一次性恢复
    }
});
</script>

<script>
function changeSortMode() {
    const selected = document.getElementById('sort-mode').value;
    const url = new URL(window.location.href);
    url.searchParams.set('sort', selected);
    url.searchParams.set('page', '1');  // 切换排序后回到第一页
    window.location.href = url.toString();
}
</script>


<script>
document.addEventListener('DOMContentLoaded', function () {
    const select = document.getElementById('has-subprojects');
    const isSegmentedField = document.getElementById('is_segmented');
    const subprojectSection = document.getElementById('subproject-section');
    const projectDepositSection = document.getElementById('project-deposit-section');
    const projectFileGroup = document.getElementById('project-file-upload-group');
    const fileUploadInput = document.querySelector('input[name="file_upload"]');
    const projectTimeSection = document.getElementById('project-time-section');
    const form = document.getElementById("add-project-form");
    const wrapper = document.getElementById("subproject-list-wrapper");
    let segmentIndex = 0;

    // ✅ 根据下拉选择更新 UI
    function updateUI() {
        const isSegmented = select.value === 'yes';
        isSegmentedField.value = isSegmented ? 'true' : 'false';

        subprojectSection.classList.toggle('d-none', !isSegmented);
        projectDepositSection.classList.toggle('d-none', isSegmented);
        projectFileGroup.classList.toggle('d-none', isSegmented);
        projectTimeSection?.classList.remove('d-none');

        if (fileUploadInput) fileUploadInput.required = !isSegmented;
        projectTimeSection?.querySelectorAll("input").forEach(input => {
            input.required = !isSegmented;
        });
    }

    // ✅ 添加标段行
    window.addSubprojectRow = function () {
       const html = `
            <div class="border rounded p-3 mb-3 bg-light subproject-block">
                <div class="mb-2">
                    <label class="form-label">标段名称</label>
                   <input type="text" class="form-control" name="segment_${segmentIndex}_name" placeholder="标段名称（可留空）">
                </div>
                <div class="mb-2">
                    <label class="form-label">保证金金额（元）</label>
                    <input type="number" step="0.01" class="form-control" name="segment_${segmentIndex}_deposit_amount" required>
                </div>
                <div class="mb-2">
                    <label class="form-label">上传文件</label>
                    <input type="file" class="form-control" name="segment_${segmentIndex}_file_upload" accept=".pdf,.doc,.docx,.zip,.rar" required>
                </div>
            </div>`;
        wrapper.insertAdjacentHTML('beforeend', html);
        segmentIndex++;
        document.getElementById('segment_count').value = segmentIndex;
    };

    // ✅ 提交前验证至少有一个标段
    form.addEventListener("submit", function (e) {
        if (isSegmentedField.value === "true") {
            const blocks = wrapper.querySelectorAll('.subproject-block');
            if (blocks.length === 0) {
                e.preventDefault();
                alert("⚠️ 请至少添加一个标段，或选择“不包含标段”以改为项目级方式");
            }
        }
    });

    // 初始化 UI
    updateUI();
    select.addEventListener('change', updateUI);
});
</script>



</body>
</html>


