<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="{{ url_for('static', filename='bid.png') }}" type="image/png">
    <title>é‚®ä»¶å‘é€è®°å½• - äº‘å—å›½åˆå¼€æ ‡ç³»ç»Ÿ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            /*background: url("../static/img/email_logs_bg.jpg") no-repeat center center fixed;*/
            background-size: cover;
            font-family: "Microsoft YaHei", sans-serif;
        }

        .panel {
            background-color: rgba(255, 255, 255, 0.95);
            padding: 30px;
            border-radius: 14px;
            max-width: 1200px;
            margin: 5vh auto;
            box-shadow: 0 0 16px rgba(0, 0, 0, 0.2);
        }

        .admin-logout-btn {
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 1000;
        }

        .logs-list {
            max-height: 700px;
            overflow-y: auto;
        }
    </style>
    <style>
        /* è®©å¤±è´¥è®°å½•è¡ŒèƒŒæ™¯æµ…çº¢è‰² */
        .failed-row {
            background-color: rgba(255, 0, 0, 0.08); /* æµ…çº¢è‰² */
        }
    </style>
    <style>
        .logs-table-wrapper {
            max-height: 700px;
            overflow-y: auto;
            padding-right: 10px;
        }
    </style>

</head>
<body>


<div class="d-flex justify-content-between align-items-center px-3"
     style="position: fixed; top: 10px; left: 0; right: 0; z-index: 1000;">
    <a href="{{ url_for('admin_panel') }}" class="btn btn-outline-secondary">ğŸ  è¿”å›é¡¹ç›®ç®¡ç†</a>
    <!--    <a href="{{ url_for('logout') }}" class="btn btn-outline-primary">é€€å‡ºç™»å½•</a>-->
</div>

<div class="panel">
    <h3 class="mb-4">ğŸ“¨ é¡¹ç›®é‚®ä»¶å‘é€è®°å½•</h3>

    <form method="POST" class="row g-3 mb-4">
        <div class="col-auto">
            <input type="datetime-local" name="start_time" class="form-control" required>
        </div>
        <div class="col-auto">
            <input type="datetime-local" name="end_time" class="form-control" required>
        </div>
        <div class="col-auto">
            <button type="submit" class="btn btn-outline-primary">ç­›é€‰æ—¶é—´èŒƒå›´</button>
        </div>
    </form>
    <div class="mb-3">
        <input type="text" id="project-filter" class="form-control" placeholder="ğŸ” è¾“å…¥é¡¹ç›®åç§°æˆ–ç¼–å·è¿›è¡Œç­›é€‰">
    </div>

    <div class="mb-3">
        <button id="toggle-failed-btn" class="btn btn-outline-danger btn-sm">åªçœ‹å¤±è´¥è®°å½•</button>
        <a href="{{ url_for('export_mail_logs') }}" class="btn btn-outline-success btn-sm">ğŸ“¤ å¯¼å‡ºå…¨éƒ¨é‚®ä»¶è®°å½• Excel</a>

    </div>

    {% if logs %}
    <div class="logs-list">
        <div class="logs-table-wrapper" style="max-height: 700px; overflow-y: auto;">
            <table class="table table-striped table-bordered">
                <thead class="table-light">
                <tr>
                    <th scope="col">åºå·</th>
                    <th scope="col">å‘é€æ—¶é—´</th>
                    <th scope="col">é¡¹ç›®åç§°</th>   <!-- âœ… æ–°å¢ -->
                    <th scope="col">é¡¹ç›®ç¼–å·</th> <!-- âœ… æ–°åŠ  -->
                    <th scope="col">çŠ¶æ€</th>
                    <th scope="col">ä¿¡æ¯</th>
                </tr>
                </thead>
                <tbody>
                {% for log in logs %}
                <tr class="{% if log.status == 'failed' %}failed-row{% endif %}">
                    <th scope="row">{{ loop.index }}</th>
                    <td>{{ log.sent_at.strftime('%Y-%m-%d %H:%M:%S') }}</td>
<!--                    <td>-->
<!--                        {% if log.project %}-->
<!--                        {{ log.project.name }}-->
<!--                        {% else %}-->
<!--                        æ— å…³è”é¡¹ç›®-->
<!--                        {% endif %}-->
<!--                    </td>-->
<!--                    <td>-->
<!--                        {% if log.project %}-->
<!--                        {{ log.project.code }}-->
<!--                        {% else %}-->
<!--                        æ— ç¼–å·-->
<!--                        {% endif %}-->
<!--                    </td>-->
                    <td>
                        {% if log.sub_project and log.sub_project.project %}
                        {{ log.sub_project.project.name }}
                        {% else %}
                        æ— å…³è”é¡¹ç›®
                        {% endif %}
                    </td>
                    <td>
                        {% if log.sub_project and log.sub_project.project %}
                        {{ log.sub_project.project.code }}
                        {% else %}
                        æ— ç¼–å·
                        {% endif %}
                    </td>


                    <td>
                        {% if log.status == "success" %}
                        <span class="badge bg-success">æˆåŠŸ</span>
                        {% else %}
                        <span class="badge bg-danger">å¤±è´¥</span>
                        {% endif %}
                    </td>
                    <td>
                        {{ log.message }}
                        {% if log.status == "failed" %}
                        <form method="POST" action="{{ url_for('retry_mail', log_id=log.id) }}" style="display:inline;">
                            <button type="submit" class="btn btn-sm btn-danger ms-2">ğŸ”„ é‡å‘</button>
                        </form>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
    {% else %}
    <p>æš‚æ— ä»»ä½•é‚®ä»¶å‘é€è®°å½•ã€‚</p>
    {% endif %}
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const toggleBtn = document.getElementById('toggle-failed-btn');
        const projectFilterInput = document.getElementById('project-filter');
        let showingFailedOnly = false;

        toggleBtn.addEventListener('click', function () {
            const rows = document.querySelectorAll('.logs-list tbody tr');

            if (!showingFailedOnly) {
                // åªæ˜¾ç¤ºå¤±è´¥è®°å½•
                rows.forEach(row => {
                    // const statusCell = row.querySelector('td:nth-child(4)');  // âœ… æ³¨æ„æ˜¯ç¬¬4åˆ—çŠ¶æ€
                    // todo:ä¸ç¡®å®šæ˜¯å¦å¯¹
                    const statusCell = row.querySelector('td:nth-child(5)');
                    if (!statusCell.innerText.includes('å¤±è´¥')) {
                        row.style.display = 'none';
                    }
                });
                toggleBtn.textContent = 'æ˜¾ç¤ºå…¨éƒ¨è®°å½•';
                showingFailedOnly = true;
            } else {
                // æ˜¾ç¤ºå…¨éƒ¨
                rows.forEach(row => {
                    row.style.display = '';
                });
                toggleBtn.textContent = 'åªçœ‹å¤±è´¥è®°å½•';
                showingFailedOnly = false;
            }
        });

        projectFilterInput.addEventListener('input', function () {
            const keyword = projectFilterInput.value.trim().toLowerCase();
            const rows = document.querySelectorAll('.logs-list tbody tr');

            rows.forEach(row => {
                const projectNameCell = row.querySelector('td:nth-child(3)');
                const projectCodeCell = row.querySelector('td:nth-child(4)');
                const messageCell = row.querySelector('td:nth-child(6)');

                const combinedText = (
                    (projectNameCell?.innerText || '') + ' ' +
                    (projectCodeCell?.innerText || '') + ' ' +
                    (messageCell?.innerText || '')
                ).toLowerCase();

                if (combinedText.includes(keyword)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        });
    });
</script>

</body>
</html>
